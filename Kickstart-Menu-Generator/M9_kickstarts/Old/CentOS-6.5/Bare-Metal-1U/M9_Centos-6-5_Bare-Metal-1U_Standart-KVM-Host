# Kickstart config file generated by Spacewalk Config Management
# Profile Label : M9_Centos-6-5_Bare-Metal-1U_Standart-KVM-Host_x86-64
# Date Created  : Fri Sep 19 18:56:00 MSK 2014

install
text
network --device eth0 --bootproto dhcp
url --url http://ix-satellite.search.km/ks/dist/centos-6.5-x86_64
lang en_US.UTF-8
keyboard us
zerombr
clearpart --all
bootloader --location=mbr --driveorder=sda,sdb,sdc
timezone --utc Europe/Moscow
auth --enablemd5 --enableshadow
rootpw --iscrypted $1$Cs9J81xU$rN.64VJYws0A2q4sXGRDR0
selinux --disabled
reboot
firewall --disabled
skipx
repo --name=spacewalk-client-centos-6.5-x86_64 --baseurl=http://ix-satellite.search.km/ks/dist/child/spacewalk-client-centos-6.5-x86_64/centos-6.5-x86_64
repo --name=epel-6.5-x86_64 --baseurl=http://ix-satellite.search.km/ks/dist/child/epel-6.5-x86_64/centos-6.5-x86_64
repo --name=centos-6.5-kmsearch-sys-prod-x86_64 --baseurl=http://ix-satellite.search.km/ks/dist/child/centos-6.5-kmsearch-sys-prod-x86_64/centos-6.5-x86_64
part raid.01 --asprimary --fstype="raid" --ondisk=sda --size=200
part raid.02 --asprimary --fstype="raid" --ondisk=sda --size=4096
part raid.03 --asprimary --fstype="raid" --ondisk=sda --size=40000
part raid.04 --asprimary --fstype="raid" --grow --ondisk=sda --size=1
part raid.05 --asprimary --fstype="raid" --ondisk=sdb --size=200
part raid.06 --asprimary --fstype="raid" --ondisk=sdb --size=4096
part raid.07 --asprimary --fstype="raid" --ondisk=sdb --size=40000
part raid.08 --asprimary --fstype="raid" --grow --ondisk=sdb --size=1
part raid.09 --asprimary --fstype="raid" --grow --ondisk=sdc --size=1
part raid.10 --asprimary --fstype="raid" --grow --ondisk=sdd --size=1
part raid.11 --asprimary --fstype="raid" --grow --ondisk=sde --size=1
part raid.12 --asprimary --fstype="raid" --grow --ondisk=sdf --size=1
raid /boot --device=md0 --fstype="ext2" --level=1 raid.01 raid.05
raid swap --device=md1 --fstype="swap" --level=0 raid.02 raid.06
raid / --device=md2 --fstype="ext4" --fsoptions noatime,commit=30,data=writeback,nobh --level=1 raid.03 raid.07
raid pv.01 --level=1 --device=md3 raid.04 raid.08
raid pv.02 --level=1 --device=md4 raid.09 raid.10
raid pv.03 --level=1 --device=md5 raid.11 raid.12
volgroup VGsys pv.01
volgroup VGdata1 pv.02
volgroup VGdata2 pv.03
logvol /data --vgname=VGsys --fstype=ext4 --fsoptions noatime,commit=30,data=writeback,nobh --size=1 --grow --name=LVdata


%packages 
coreutils
yum
yum-plugin-priorities
rpm
e2fsprogs
lvm2
grub
sysstat
ntp
ntpdate
openssh-server
openssh-clients
vim-enhanced
OpenIPMI
sudo
e4fsprogs
mc
mtr
tcpdump
dstat
iotop
wget
rsync
iptstate
smartmontools
bind-utils
telnet
psmisc
man
kvm
virt-clone
bridge-utils
tunctl
libvirt
dmidecode
avahi
pbzip2
pigz
rhn-client-tools
rhn-check
rhn-setup
rhnsd
m2crypto
yum-rhn-plugin
rhncfg
rhncfg-actions
rhncfg-client
-dhcpv6-client
-iptables-ipv6
-system-config-securitylevel-tui
-wireless-tools
-rhpl
puppet
bash-completion
-cpuspeed
-abrt*
osad
%end

%pre

wget "http://ix-satellite.search.km/cblr/svc/op/trig/mode/pre/profile/M9_Centos-6-5_Bare-Metal-1U_Standart-KVM-Host_x86-64:1:KMSearch" -O /dev/null



echo "Saving RHN keys..." > /dev/ttyS0
SYSTEM_ID=/etc/sysconfig/rhn/systemid
rhn_keys_found=no

mkdir -p /tmp/rhn

drives=$(list-harddrives | awk '{print $1$Cs9J81xU$rN.64VJYws0A2q4sXGRDR0
for disk in $drives; do
    DISKS="$DISKS $(fdisk -l /dev/$disk | grep -v "swap\|LVM\|Extended" | awk '/^\/dev/{print $1$Cs9J81xU$rN.64VJYws0A2q4sXGRDR0
done

# Try to find the keys on ordinary partitions
for disk in $DISKS; do
    name=test-$(basename $disk)
    mkdir -p /tmp/$name
    mount $disk /tmp/$name
    [ $? -eq 0 ] || continue # Skip to the next partition if the mount fails

    # Copy current RHN host keys out to be reused
    if [ -f /tmp/${name}$SYSTEM_ID ]; then
        cp -a /tmp/${name}$SYSTEM_ID /tmp/rhn
        rhn_keys_found="yes"
        umount /tmp/$name
        break
    fi
    umount /tmp/$name
    rm -r /tmp/$name
done

# Try LVM if that didn't work
if [ "$rhn_keys_found" = "no" ]; then
    lvm lvmdiskscan
    vgs=$(lvm vgs | tail -n +2 | awk '{ print $1$Cs9J81xU$rN.64VJYws0A2q4sXGRDR0
    for vg in $vgs; do
        # Activate any VG we found
        lvm vgchange -ay $vg
    done
    
    lvs=$(lvm lvs | tail -n +2 | awk '{ print "/dev/" $2 "/" $1$Cs9J81xU$rN.64VJYws0A2q4sXGRDR0
    for lv in $lvs; do
        tmpdir=$(mktemp -d findkeys.XXXXXX)
        mkdir -p /tmp/${tmpdir}
        mount $lv /tmp/${tmpdir} || continue # Skip to next volume if this fails

        # Let's see if the keys are in there
        if [ -f /tmp/${tmpdir}$SYSTEM_ID ]; then
            cp -a /tmp/${tmpdir}$SYSTEM_ID /tmp/rhn/
            rhn_keys_found="yes"
            umount /tmp/${tmpdir}
            break # We're done!
        fi
        umount /tmp/${tmpdir}
        rm -r /tmp/${tmpdir}
    done
    
    # And clean up..
    for vg in $vgs; do
        lvm vgchange -an $vg
    done
fi


%end

%post --nochroot
mkdir /mnt/sysimage/tmp/ks-tree-copy
if [ -d /oldtmp/ks-tree-shadow ]; then
cp -fa /oldtmp/ks-tree-shadow/* /mnt/sysimage/tmp/ks-tree-copy
elif [ -d /tmp/ks-tree-shadow ]; then
cp -fa /tmp/ks-tree-shadow/* /mnt/sysimage/tmp/ks-tree-copy
fi
cp /etc/resolv.conf /mnt/sysimage/etc/resolv.conf
cp -f /tmp/ks-pre.log* /mnt/sysimage/root/ || :

cp `awk '{ if ($1$Cs9J81xU$rN.64VJYws0A2q4sXGRDR0
%end

%post --nochroot --interpreter /usr/bin/python
try:
    import xmlrpclib
    import shutil
    import sys
    import os.path
    old_system_id = "/tmp/rhn/systemid"
    new_system_id = "/mnt/sysimage/root/systemid.old"
    tmp_key = "/mnt/sysimage/tmp/key"

    new_keys = "1-d8f17b528b54eacad7c40b04a5daa58f,1-dc02192f57ad21dc7f611b311d52fec8"
    for key in new_keys.split(','):
        if key.startswith('re-'):
            sys.exit(0)
    if os.path.exists(old_system_id):
        client =  xmlrpclib.Server("http://ix-satellite.search.km/rpc/api")
        key = client.system.obtain_reactivation_key(open(old_system_id).read())
        if os.path.exists(tmp_key):
            f = open(tmp_key, "r+")
            contents = f.read()
            if contents and not contents[-1] == ',':
                f.write(',')
        else:
            f = open(tmp_key, "w")
        f.write(key)
        f.close()
        shutil.copy(old_system_id, new_system_id)
except:
    # xml rpc due to  a old/bad system id
    # we don't care about those
    # we'll register those as new.
    pass


%end

%post --log /root/ks-rhn-post.log
# --Begin Spacewalk command section--
cat > /tmp/gpg-key-1 <<'EOF'
-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: GnuPG v1.4.5 (GNU/Linux)

mQGiBEpBgEURBAC+CL1a6BfVEoKAX1KcOHqq9Z10WdPGOgTM+AtnOVPJdJvIZcDk
YGUmycpaGxY3+xX1x8ZvxNb7WXiei8FMPm4sR/xQC/CF2iS5399tjLJqcDEjdqTV
/whQ4Rrg1JLGaHUjR0YmrOteT71xikEwlCalToxQuhBz7Nz4aBeDDPf9lwCgvG+x
CaOxict+He03g4HNSTZ0T0UEAIxKITpCA6ZvUPoEGhpn+Gt+wJK/ScB0FKCfW8Au
QQZP6tgxDEg0baasT8MxuXXE2+opaaWPTVa64ws7OvbyH5z1xhBOx4qRVBx8bZsF
YQUk/1PBvg6yA4Rmaqi7nTToHatP69/JMLfTyH8sXETMQ8z5T0LAD6a5ELAYBqql
bJWRA/4lkbaGIwkyLcOAop/g0SCERHt66ML1pwdjxvzE2rRKFUbjUbRZsHTqVq5E
BgpcTIeTuRy02yQ+Bh+JaBtYhn0AY5+t7jcCdJeTahS/7RKJPYPiSfbgI6zwpHM9
kX4FT+0yDgnVF1H/h9p19Uv/3ahIgt7op/M1eAdH0/eP6Dv04rQnWXVtIE1haW50
YWluZXIgPHdlYm1hc3RlckBjbG91ZGVyYS5jb20+iGAEExECACAFAkpBgEUCGwMG
CwkIBwMCBBUCCAMEFgIDAQIeAQIXgAAKCRD5DA2P6PhqzRo1AKCIHNWJSd7OipbZ
qp58f/BWaIBlDACggNRH4Hvg92t3xtwYFdohRWF2Xbi5Ag0ESkGARxAIAMaPPGfQ
vsLkyLyM3ePtkkHi0bew0XGW1CYxWOZLMu8wnJgMHpfPD2dLgp6PEh+zpi2SM1ie
QGAW6K040TSuC9P+LcZB7SxanIE7lONHjz7spGQift30WFZcaIgF+MuyZIihNh7v
tZ9ip8JZYPA88XRNU1CKuXx4r8iCDJ4ICksFKeOwQUuzf/IRJapzEZ0ixfVTwx91
yG10TvHK63BRLXYHBML4Og9FaPZgFq2N9Yz4Wpu/Pn6tjZAMeSJXm2qNO2PSoTC/
kapubpMwSmOBlZqrHi9lcIWricXE9dcyaGVRAf3CJRlX4ZNuwcQjyks5BFibU3/z
qlzP6KgwTgDmaaMAAwUH/04KRM3k6Ow2KkDt2BKWveOI24mkIQahUJ7/iZlKsL27
3VcGQZ7jU28GT0FH9iYeAgbpLrrEuDAFZpGm9RoOVJGnxWX3DVL1+qkiS56pXfU+
8atZlkCGx09IilJgf0ATlmYxbTtYliTRPK4lQYOfNB1v23bdlBwISjcDRkWu22ao
atSBzr/FARL6fdZZqp2qfWOmcteiLagioo6s0ogxKNQH5PldUQy9n2W/oOXss5sC
lnUNvzKlzzx/pFkT8ZUAvuLY0v8gykk586vbjiuPkg8uAOBhtnsSWwJ6nEPaRCnu
iwlqGxgXmnJ7UMzOimkuf0XvqavhkMEEAqRJkNLyWVuISQQYEQIACQUCSkGARwIb
DAAKCRD5DA2P6PhqzUV2AJ0eV3C407Y3Xi4d27clLsz/wW0HMgCghcxCmiOT2kWH
6Ya7d9nkKz2UM+Y=
=+VR8
-----END PGP PUBLIC KEY BLOCK-----
EOF
# gpg-key1
rpm --import /tmp/gpg-key-1
cat > /tmp/gpg-key-2 <<'EOF'
-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: GnuPG v2.0.18 (GNU/Linux)

mQGiBE9V9U0RBADjRxY1+Ng5gzaAj2LYHNwXHzyH65p+jL80+2vkf6WCNvewa+zK
SY8JH3syZMhjGi/vW3TcDy5KVqiXS2rpMJS6zCBrOJbtcFdV3VvbsPd7hK9COlph
NUx5RSIIwZRg1wyEjgeuYOSLuIhqNsI+fjXk+uzletSLtIYUF3TUq5jCvwCg4XQ/
/RPOFH6KiHfIx8QUZmvT0IkD/ip7pOn5uSPNiIbj3X5RYbz8PB/z5OuoenfzYn4R
WDBXZBlWMaPJCupAYwdP9IsiXo8WvbyXPHgG91P/MStrCgOffACNhuMus1FwqlCQ
VFuKENB6f2g4DY9Mow6bKYgsSEy0qnEF5I2M+BqjApO0oznxzcyJ4coXQdA9/oCP
vYU5A/9FTgukU1p/CbNJIhT4iH+vE6cKFGAtzhwwQxMdnii8ctcKiCYgiimuU7OG
rcPKR1xsRX/sc6XZYJeLmc1Lt7Btkdl36RY5BgesVJkUNyKh8+7MllW5PvVFvtGv
vvvrRVK+mJYxdBU0/Sqc94ZgBW6vdvRwHgXhpKor6NsCfJUWvLQmU3BhY2V3YWxr
IDxzcGFjZXdhbGstZGV2ZWxAcmVkaGF0LmNvbT6IaAQTEQIAKAUCT1X1TQIbAwUJ
BKKGAAYLCQgHAwIGFQgCCQoLBBYCAwECHgECF4AACgkQDmRvaIY6hT16sQCfVuJv
KnSWzWXo0ek16NrqUSgdTYIAn3Q6Jc3GAzkx/JgmA6T6pLxp2f1uiEYEEBECAAYF
Ak9V/egACgkQ7WNTebOJITK97gCfdeNye+OKidB2huEfzxP37ZkdfSIAniAA4NMY
QsmjPPkUJSVguO7GbdXSuQINBE9V9U0QCACBbWXaPP5RqAIGnr9LeFbSYpWs2SnL
KPv0qylyOGMc3GwmpJjeuz1d4y5fHIQxsQl7+RLIxOARcYH1QL6gHN450JcpYzau
/Lj1ArsAP/QK/J8YSmjG0E0rU8sYRWIu7jzISgfMAs3c3wNvOMUCiXtXFV6crm9q
3kbrZTedWLkShSLDAp5394hmBbRicWnc9h4LwBKp+BBtsvJFfDydc8IJUGZLZNZT
RayYWC5VMDe1xmOZXhNpDxfNrjhUUI6E6qWwdinmzifhP6z6YNtRON1yWSLBwtcr
LghyEJlilijIbCDgZ8Nvtqy/c2ypcLxMrXy70x05fjcQK2KIuLI58GGDAAMFB/9n
m5YLj4S4XxF8/xP7givuPq37C7NYLOuzFKKx6xxqngV8TNGDVU2zv/lieh2ussXE
XF/S9Du2abpXYgxsxwFJNMMKXUam03ExFSUvUAco6nmxySzvtgudCZ/9HqLhbNVu
RpyUNA/g9vkYK6KVdxAeHUdu/EwfSL/pCEc11Dw1jYqbihktlTQPcizsSPG4Y7jh
OUrKgxJop9DovUGzuUSl/7zYr4W7TiGV3my0f7U3qkpVT0bQoMnw8TxCZj4x3umo
F4klakeGX0FK4vwV5hDq32Q6vWN804F34Vi3WsaUT9G1E3H7/s/OQgWLOm16mgjR
pN1E79kYwtPMCAz0pYMciE8EGBECAA8FAk9V9U0CGwwFCQSihgAACgkQDmRvaIY6
hT3D2ACfYsiYS39rFdR1aBHviE0hVm9MWxUAnR3Ua92zW/0UoJ7TgxR0Dxzta37z
=yqYQ
-----END PGP PUBLIC KEY BLOCK-----
EOF
# gpg-key2
rpm --import /tmp/gpg-key-2
cat > /tmp/gpg-key-3 <<'EOF'
-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: GnuPG v1.4.5 (GNU/Linux)

mQINBE4P1EIBEACfrYbqfmCxVzfO3P9NGC2Ul9EyzDNW9WK0yYt1kT45cjybC+vL
8gPl5BlVC9Z5WoSU9YhCwk/RdQ0aQJQRziEyQqwftSgKESrApAqEyHIkcsPNCkjq
55q9MkhJApMn14dwvCJCgubDSj2Ft8b172IlIX3k196uCZl9j5EVUHuyxls4AOUZ
7wuvEXLu01KOi5lqnsGwyRTv+AV74LupL03iZUPQuGUWPuP25J35sC4p33We5Ogx
VrjOv6/e5Z0p9zb2AgBh1hFRwPPgE3wrYJIF5tmJgDDdKIPcNFE1l2QiOlPg/QA4
t0f6gUk0ptgrWlNmAhj8y8ccomf/JgmjfQbjFXWkqIePVzQy9adM6SbmKFm/czJ1
X1Jsy7lCzpxYqz8RYds8EzD455auJ0TeiO4P0PFd+RXncH10mGIESP/DTicWvVdK
0doBLpYcpwyNL4dyQxq28xtneFgYV+Zkazk0HzF3+x+vnD+LZ1Zc9/MXub/Yt5nv
1eaQrSfSkCDvq5rXzzprqVe6Ytl+FK5lwbJGhOUWfsWk0PqChkEhw2n7zgHpQ5Qd
U5oMFFKy3B1ZYQRn581/wB+eL/fgku7icIo/IOU7zeKDmIK7xHuHiAmVtm7L35VL
qAbgSY5B5EBqP6RtBT7AIKzM/+H5uMvnS4xI5PVkJVijL6Fpw8aHEeCDVQARAQAB
tFdDZW50T1MtNiBEZWJ1Z2luZm8gS2V5IChDZW50T1MtNiBEZWJ1Z2luZm8gU2ln
bmluZyBLZXkpIDxjZW50b3MtNi1kZWJ1Zy1rZXlAY2VudG9zLm9yZz6JAjwEEwEC
ACYFAk4P1EICGwMFCRLMAwAGCwkIBwMCBBUCCAMEFgIDAQIeAQIXgAAKCRA7dc95
0P89FkPID/4w8+3Yg7lZfTkPynWcSX4KOH6NRCSbuUf+5MFmZT4FXVOr7LHOWCRS
QkF3f+tpPIpGLcEFD9r0/9npozsviG/13ZhT31x3mmASvVVGVp9cHN5Ie7Zim2BN
+ALbGQ0YbaO7f7XgBMTKTlw71HQ5V4yCqrUVBL1FicGBsBJ5nfJt/K0WjKA1GGYA
DyW1YP/Oid5lPNqPLyR3Jw2oMHtUtbwZbtgBSq8Ll5gZaYTpap+M4SdQmBXyOMxA
NPXSwJgNuWufKnwp+7qMR/sFRIW9qmRvR30NtonmzOwf+kOtY03USiSK4pneEHTQ
YKAGCEdOgsPOnEwv0jvW3KABIw+rwRzkpfW0IFh0VoyOrQ67Ek0Q3oldQ9Lrjwqu
qsL12YhBgfnMkSM/w7R0HsezOSmPb0wHxjIb6CDv+4r9LIHx5F4YXFytv7pYIUqP
6ATg9jJ/ecMcXVonnwwUG2FtQNhYa4URak1u3u0xJTKsrsvMnYksjCpgosmd4XB4
7651UvR7pgsSscJSuLlh9S4BR3/crsYZMq1O5L9HOywU4l2SN04p+DfH2Vf90VfB
9An1uA2hBa5lB1IuN0QiIH9OMaDqXPk0rVHS0GJ28Jx4rztofDBWHuShgO5YzNUw
A8CKB3t/kH6zutLdF6tS0Mh1wLWuPWfSH4DPd+mSucY/zbbrrAgxFA==
=9b/M
-----END PGP PUBLIC KEY BLOCK-----
EOF
# gpg-key3
rpm --import /tmp/gpg-key-3
cat > /tmp/gpg-key-4 <<'EOF'
-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: GnuPG v1.4.5 (GNU/Linux)

mQINBE4P06MBEACqn48FZgYkG2QrtUAVDV58H6LpDYEcTcv4CIFSkgs6dJ9TavCW
NyPBZRpM2R+Rg5eVqlborp7TmktBP/sSsxc8eJ+3P2aQWSWc5ol74Y0OznJUCrBr
bIdypJllsD9Fe+h7gLBXTh3vdBEWr2lR+xA+Oou8UlO2gFbVFQqMafUgU1s0vqaE
/hHH0TzwD0/tJ6eqIbHwVR/Bu6kHFK4PwePovhfvyYD9Y+C0vOYd5Ict2vbLHz1f
QBDZObv4M6KN3j7nzme47hKtdMd+LwFqxM5cXfM6b5doDulWPmuGV78VoX6OR7el
x1tlfpuiFeuXYnImm5nTawArcQ1UkXUSYcTUKShJebRDLR3BycxR39Q9jtbOQ29R
FumHginovEhdUcinRr22eRXgcmzpR00zFIWoFCwHh/OCtG14nFhefuZ8Z80qbVhW
2J9+/O4tksv9HtQBmQNOK5S8C4HNF2M8AfOWNTr8esFSDc0YA5/cxzdfOOtWam/w
lBpNcUUSSgddRsBwijPuWhVA3NmA/uQlJtAo4Ji5vo8cj5MTPG3+U+rfNqRxu1Yc
ioXRo4LzggPscaTZX6V24n0fzw0J2k7TT4sX007k+7YXwEMqmHpcMYbDNzdCzUer
Zilh5hihJwvGfdi234W3GofttoO+jaAZjic7a3p6cO1ICMgfVqrbZCUQVQARAQAB
tEZDZW50T1MtNiBLZXkgKENlbnRPUyA2IE9mZmljaWFsIFNpZ25pbmcgS2V5KSA8
Y2VudG9zLTYta2V5QGNlbnRvcy5vcmc+iQI8BBMBAgAmBQJOD9OjAhsDBQkSzAMA
BgsJCAcDAgQVAggDBBYCAwECHgECF4AACgkQCUb8osEFud6ajRAAnb6d+w6Y/v/d
MSy7UEy4rNquArix8xhqBwwjoGXpa37OqTvvcJrftZ1XgtzmTbkqXc+9EFch0C+w
ST10f+H0SPTUGuPwqLkg27snUkDAv1B8laub+l2L9erzCaRriH8MnFyxt5v1rqWA
mVlRymzgXK+EQDr+XOgMm1CvxVY3OwdjdoHNox4TdVQWlZl83xdLXBxkd5IRciNm
sg5fJAzAMeg8YsoDee3m4khg9gEm+/Rj5io8Gfk0nhQpgGGeS1HEXl5jzTb44zQW
qudkfcLEdUMOECbu7IC5Z1wrcj559qcp9C94IwQQO+LxLwg4kHffvZjCaOXDRiya
h8KGsEDuiqwjU9HgGq9fa0Ceo3OyUazUi+WnOxBLVIQ8cUZJJ2Ia5PDnEsz59kCp
JmBZaYPxUEteMtG3yDTa8c8jUnJtMPpkwpSkeMBeNr/rEH4YcBoxuFjppHzQpJ7G
hZRbOfY8w97TgJbfDElwTX0/xX9ypsmBezgGoOvOkzP9iCy9YUBc9q/SNnflRWPO
sMVrjec0vc6ffthu2xBdigBXhL7x2bphWzTXf2T067k+JOdoh5EGney6LhQzcp8m
YCTENStCR+L/5XwrvNgRBnoXe4e0ZHet1CcCuBCBvSmsPHp5ml21ahsephnHx+rl
JNGtzulnNP07RyfzQcpCNFH7W4lXzqM=
=jrWY
-----END PGP PUBLIC KEY BLOCK-----
EOF
# gpg-key4
rpm --import /tmp/gpg-key-4
cat > /tmp/gpg-key-5 <<'EOF'
-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: GnuPG v1.4.7 (GNU/Linux)

mQGiBEeD8koRBACC1VBRsUwGr9gxFFRho9kZpdRUjBJoPhkeOTvp9LzkdAQMFngr
BFi6N0ov1kCX7LLwBmDG+JPR7N+XcH9YR1coSHpLVg+JNy2kFDd4zAyWxJafjZ3a
9zFg9Yx+0va1BJ2t4zVcmKS4aOfbgQ5KwIOWUujalQW5Y+Fw39Gn86qjbwCg5dIo
tkM0l19h2sx50D027pV5aPsD/2c9pfcFTbMhB0CcKS836GH1qY+NCAdUwPs646ee
Ex/k9Uy4qMwhl3HuCGGGa+N6Plyon7V0TzZuRGp/1742dE8IO+I/KLy2L1d1Fxrn
XOTBZd8qe6nBwh12OMcKrsPBVBxn+iSkaG3ULsgOtx+HHLfa1/p22L5+GzGdxizr
peBuA/90cCp+lYcEwdYaRoFVR501yDOTmmzBc1DrsyWP79QMEGzMqa393G0VnqXt
L4pGmunq66Agw2EhPcIt3pDYiCmEt/obdVtSJH6BtmSDB/zYhbE8u3vLP3jfFDa9
KXxgtYj0NvuUVoRmxSKm8jtfmj1L7zoKNz3jl+Ba3L0WxIv4+bRBUG9zdGdyZVNR
TCBSUE0gQnVpbGRpbmcgUHJvamVjdCA8cGdzcWxycG1zLWhhY2tlcnNAcGdmb3Vu
ZHJ5Lm9yZz6IYAQTEQIAIAUCR4PySgIbIwYLCQgHAwIEFQIIAwQWAgMBAh4BAheA
AAoJEB8W0uFELfD4jnkAoMqd6ZwwsgYHZ3hP9vt+DJt1uDW7AKDbRwP8ESKFhwdJ
8m91RPBeJW/tMLkCDQRHg/JKEAgA64+ZXgcERPYfZYo4p+yMTJAAa9aqnE3U4Ni6
ZMB57GPuEy8NfbNya+HiftO8hoozmJdcI6XFyRBCDUVCdZ8SE+PJdOx2FFqZVIu6
dKnr8ykhgLpNNEFDG3boK9UfLj/5lYQ3Y550Iym1QKOgyrJYeAp6sZ+Nx2PavsP3
nMFCSD67BqAbcLCVQN7a2dAUXfEbfXJjPHXTbo1/kxtzE+KCRTLdXEbSEe3nHO04
K/EgTBjeBUOxnciH5RylJ2oGy/v4xr9ed7R1jJtshsDKMdWApwoLlCBJ63jg/4T/
z/OtXmu4AvmWaJxaTl7fPf2GqSqqb6jLCrQAH7AIhXr9V0zPZwADBQgAlpptNQHl
u7euIdIujFwwcxyQGfee6BG+3zaNSEHMVQMuc6bxuvYmgM9r7aki/b0YMfjJBk8v
OJ3Eh1vDH/woJi2iJ13vQ21ot+1JP3fMd6NPR8/qEeDnmVXu7QAtlkmSKI9Rdnjz
FFSUJrQPHnKsH4V4uvAM+njwYD+VFiwlBPTKNeL8cdBb4tPN2cdVJzoAp57wkZAN
VA2tKxNsTJKBi8wukaLWX8+yPHiWCNWItvyB4WCEp/rZKG4A868NM5sZQMAabpLd
l4fTiGu68OYgK9qUPZvhEAL2C1jPDVHPkLm+ZsD+90Pe66w9vB00cxXuHLzm8Pad
GaCXCY8h3xi6VIhJBBgRAgAJBQJHg/JKAhsMAAoJEB8W0uFELfD4K4cAoJ4yug8y
1U0cZEiF5W25HDzMTtaDAKCaM1m3Cbd+AZ0NGWNg/VvIX9MsPA==
=au6K
-----END PGP PUBLIC KEY BLOCK-----
EOF
# gpg-key5
rpm --import /tmp/gpg-key-5
cat > /tmp/gpg-key-6 <<'EOF'
-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: GnuPG v1.4.5 (GNU/Linux)

mQINBEvSKUIBEADLGnUj24ZVKW7liFN/JA5CgtzlNnKs7sBg7fVbNWryiE3URbn1
JXvrdwHtkKyY96/ifZ1Ld3lE2gOF61bGZ2CWwJNee76Sp9Z+isP8RQXbG5jwj/4B
M9HK7phktqFVJ8VbY2jfTjcfxRvGM8YBwXF8hx0CDZURAjvf1xRSQJ7iAo58qcHn
XtxOAvQmAbR9z6Q/h/D+Y/PhoIJp1OV4VNHCbCs9M7HUVBpgC53PDcTUQuwcgeY6
pQgo9eT1eLNSZVrJ5Bctivl1UcD6P6CIGkkeT2gNhqindRPngUXGXW7Qzoefe+fV
QqJSm7Tq2q9oqVZ46J964waCRItRySpuW5dxZO34WM6wsw2BP2MlACbH4l3luqtp
Xo3Bvfnk+HAFH3HcMuwdaulxv7zYKXCfNoSfgrpEfo2Ex4Im/I3WdtwME/Gbnwdq
3VJzgAxLVFhczDHwNkjmIdPAlNJ9/ixRjip4dgZtW8VcBCrNoL+LhDrIfjvnLdRu
vBHy9P3sCF7FZycaHlMWP6RiLtHnEMGcbZ8QpQHi2dReU1wyr9QgguGU+jqSXYar
1yEcsdRGasppNIZ8+Qawbm/a4doT10TEtPArhSoHlwbvqTDYjtfV92lC/2iwgO6g
YgG9XrO4V8dV39Ffm7oLFfvTbg5mv4Q/E6AWo/gkjmtxkculbyAvjFtYAQARAQAB
tCFFUEVMICg2KSA8ZXBlbEBmZWRvcmFwcm9qZWN0Lm9yZz6JAjYEEwECACAFAkvS
KUICGw8GCwkIBwMCBBUCCAMEFgIDAQIeAQIXgAAKCRA7Sd8qBgi4lR/GD/wLGPv9
qO39eyb9NlrwfKdUEo1tHxKdrhNz+XYrO4yVDTBZRPSuvL2yaoeSIhQOKhNPfEgT
9mdsbsgcfmoHxmGVcn+lbheWsSvcgrXuz0gLt8TGGKGGROAoLXpuUsb1HNtKEOwP
Q4z1uQ2nOz5hLRyDOV0I2LwYV8BjGIjBKUMFEUxFTsL7XOZkrAg/WbTH2PW3hrfS
WtcRA7EYonI3B80d39ffws7SmyKbS5PmZjqOPuTvV2F0tMhKIhncBwoojWZPExft
HpKhzKVh8fdDO/3P1y1Fk3Cin8UbCO9MWMFNR27fVzCANlEPljsHA+3Ez4F7uboF
p0OOEov4Yyi4BEbgqZnthTG4ub9nyiupIZ3ckPHr3nVcDUGcL6lQD/nkmNVIeLYP
x1uHPOSlWfuojAYgzRH6LL7Idg4FHHBA0to7FW8dQXFIOyNiJFAOT2j8P5+tVdq8
wB0PDSH8yRpn4HdJ9RYquau4OkjluxOWf0uRaS//SUcCZh+1/KBEOmcvBHYRZA5J
l/nakCgxGb2paQOzqqpOcHKvlyLuzO5uybMXaipLExTGJXBlXrbbASfXa/yGYSAG
iVrGz9CE6676dMlm8F+s3XXE13QZrXmjloc6jwOljnfAkjTGXjiB7OULESed96MR
XtfLk0W5Ab9pd7tKDR6QHI7rgHXfCopRnZ2VVQ==
=V/6I
-----END PGP PUBLIC KEY BLOCK-----
EOF
# gpg-key6
rpm --import /tmp/gpg-key-6
cat > /tmp/gpg-key-7 <<'EOF'
-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: GnuPG v2.0.14 (GNU/Linux)

mQENBE+EJ9ABCACrbrOCgimBrUdH+Zmnohm1WDykOgcIlpBwVSIxYXzBcBoYA+SA
GWG1hciyeQOzXaJdFWK7Bcdscp63q6kwGCuZNSWvVwOzYuVhP4V8ude7ZCPYcTPS
QjhsAreue5bJVlUOLBQafRaZDh3oMYKjET/GX9QwQNFQz3fysX78UWjE0XvpTMC4
nUDioi73GggUvDl3ahSDy8K/aIZ+WD1eApll/TQLXvamytHX1lXEvJFa7B47Yc7F
8cpqPyxXaAmLPaUBMygdnrY9UTFbXXxh/0R4zZ+LxjcfV25eKSeaQ8PUzvCyrkj2
EFgpcVihLe8kYRDuNb49M1AuEXCLGgM8M44VABEBAAG0NXN5c2FkbS5rbSAoa2V5
IGZvciBDZW50b3MgNiByZXBvKSA8c3lzYWRtQHBvc3Qua20ucnU+iQE4BBMBAgAi
BQJPhCfQAhsDBgsJCAcDAgYVCAIJCgsEFgIDAQIeAQIXgAAKCRDc2UB2W9FxD91o
B/90PJDUEtXvgZwc1t9YP3ztWzVWGs2ITHx0EvhkABNJeDcBbSxgA07Yvg7Q6umS
LggeO4POznRYWvegrgUaCwkEb5Vjx7kO3LqGVIRJ91aOZElP6sqcgzqxT3DOjxHi
256LLIoBrHN1hFG6jfnfkdIbLtop8Tk115FMlIJuKCue0RYiJyDoGKCFVPOmKniT
JC4OBjKpoM9qR5zz97oW5IEOT/UJPZ3oksA8zZnAxW6mPQqUMdi95fSiON6RF6j/
v31jzfJ9cXCXb6mZXy02h9SPVyw1NgFIhwuhYPOq0+nJRP9CfSpOB4vZ/frzYIij
q19r14opA/bwBC7XhlOGJ9V+uQENBE+EJ9ABCADDx6L6JvW6kyF04BPGnA6bP/mS
jaQCmJHE89EHw5I3WHne5ipCynVSoIouA+CQJHmObOhaaLeKcjRR5i5MIW+109uo
GJPzpKpJ6W9quOYUeDNkhgWkk4ptWKFGlerRkjMQXur4JLAYrt6ItDi8zsI2RKTx
lcWpCR/pnw8w04LXOPt4x9wrpiVNBH8XBVFoeBbAEwP69UqIBTRCOVVfHIW6pGto
jrmfMLk2y0ebr0GjYx8XurGjbkjJ4q+BU9EeCmctAzbsW9plt2QwbygYtAhNqZSj
KWEecqCLuoz2sWemcp/5onH7hj4PcLExbcmtAi4ceH5Z/REzc193PE49S9FVABEB
AAGJAR8EGAECAAkFAk+EJ9ACGwwACgkQ3NlAdlvRcQ+63Qf+OXab7Ohs345+zaY/
gKjQnfPSawFcHeuJvvsi/Ib3PuT/1idMpymdItmSg+fGU/Mj/0E4XdW8ngXvMf3M
nndrWzq70nhUuyInFsVHEjTjC9W+/aQcIfxv43Y4gUxk0egmm3VIVuW3av/zaVXl
eqnByRJ2vMIY+FXS5gkJNa7vVXypgm8yNzcgyxO3XzUHhyrd5Cf7O++bJuWL9ob6
Ouuhu60yHkXuyyJQbTVoTstyJ+HigLSIT14BVK66Cx/Gx0C3gR0RGgrf0Y/waF3Q
C68TL3q58xsfkl9efOAita/6zcC0VflclZztFVkX9qH/7t8Yp4Z2c6Hrx0gyoe8p
tKcBrQ==
=a4Ff
-----END PGP PUBLIC KEY BLOCK-----
EOF
# gpg-key7
rpm --import /tmp/gpg-key-7
cat > /tmp/ssl-key-1 <<'EOF'
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number: 10304427997564354992 (0x8f00aeab2869c1b0)
    Signature Algorithm: sha1WithRSAEncryption
        Issuer: C=RU, ST=Central Region, L=Moscow, O=KMSearch, OU=ix-satellite.search.km, CN=ix-satellite.search.km
        Validity
            Not Before: Jun  3 18:06:25 2014 GMT
            Not After : May 28 18:06:25 2036 GMT
        Subject: C=RU, ST=Central Region, L=Moscow, O=KMSearch, OU=ix-satellite.search.km, CN=ix-satellite.search.km
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)
                Modulus:
                    00:d3:10:73:12:01:98:dd:75:88:5c:52:88:71:37:
                    a4:66:f3:95:b1:14:d7:ac:f2:d2:03:a3:84:cb:79:
                    94:37:cc:02:fa:63:5b:a9:57:a0:61:a7:a3:35:d9:
                    42:53:83:c7:7b:d9:63:55:1f:f9:aa:74:22:e6:74:
                    68:3b:f6:dd:ff:df:78:4f:e2:6c:d5:de:5a:99:3a:
                    01:d6:ca:c3:9b:3b:de:b5:98:47:2f:8d:c4:78:08:
                    aa:3c:10:89:2a:1a:c9:93:91:6d:7e:aa:be:f0:a8:
                    9a:a2:15:fa:0c:2c:c0:53:42:74:76:0d:a6:e8:c4:
                    df:a9:e8:3b:3b:39:20:15:41:32:a9:f8:9a:ff:2c:
                    81:e1:33:ee:1e:e3:5b:3d:a2:f8:c6:02:3e:68:30:
                    4d:f8:d2:f2:cd:a2:55:be:e2:f9:93:4f:52:aa:f4:
                    2f:88:66:b5:f8:c5:88:f7:ed:94:3e:0c:21:0d:62:
                    5b:5f:1f:70:6d:15:95:f7:93:8e:58:7e:b0:4f:91:
                    dc:85:4a:c2:0c:59:ef:85:fd:d4:bb:4c:2d:5b:37:
                    f3:04:3d:7a:c2:78:6b:ca:e0:e4:ee:ab:e8:de:94:
                    1c:9d:e0:d3:04:fc:13:bd:ac:62:fe:db:e4:1b:22:
                    dd:1d:69:a6:42:03:ee:a3:ae:0b:8a:fc:36:33:de:
                    3a:83
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Basic Constraints: 
                CA:TRUE
            X509v3 Key Usage: 
                Digital Signature, Key Encipherment, Certificate Sign
            X509v3 Extended Key Usage: 
                TLS Web Server Authentication, TLS Web Client Authentication
            Netscape Comment: 
                RHN SSL Tool Generated Certificate
            X509v3 Subject Key Identifier: 
                DB:13:7B:E3:04:68:CD:44:6D:90:67:F0:07:8C:E7:62:77:28:C5:DD
            X509v3 Authority Key Identifier: 
                keyid:DB:13:7B:E3:04:68:CD:44:6D:90:67:F0:07:8C:E7:62:77:28:C5:DD
                DirName:/C=RU/ST=Central Region/L=Moscow/O=KMSearch/OU=ix-satellite.search.km/CN=ix-satellite.search.km
                serial:8F:00:AE:AB:28:69:C1:B0

    Signature Algorithm: sha1WithRSAEncryption
         7e:ae:17:5d:96:d3:c8:c3:f1:69:b2:74:a4:24:28:2d:9c:79:
         90:74:5c:27:56:d3:7a:e7:42:08:78:b9:82:58:9b:8c:55:9d:
         e8:2e:2f:63:a3:a1:23:27:e1:09:5b:eb:b9:9b:db:4a:2f:80:
         54:da:b4:4e:93:16:6e:3a:90:40:30:cb:1e:93:81:f4:43:54:
         27:ea:5f:12:25:e5:dc:81:5d:37:42:38:9d:33:a3:74:5a:f5:
         00:a2:6c:b9:8f:59:11:11:f1:ef:3d:d5:f0:43:7a:99:ed:29:
         55:d7:cc:b2:b7:c7:36:dd:1e:3e:1c:01:3d:da:77:b2:16:48:
         2e:e6:8c:51:3b:9d:f9:ca:05:ec:ca:7d:1f:b1:09:10:ee:ad:
         a9:74:90:b5:0c:e7:a5:99:3b:b4:44:31:9a:0f:77:b5:e7:0c:
         85:ab:a9:53:6a:da:31:67:ed:72:8d:2c:98:ea:39:54:27:87:
         7e:b5:c3:80:7c:39:60:40:2f:ab:90:c1:c2:22:1a:f3:15:d7:
         24:5a:68:d4:57:56:60:9c:f7:2d:76:3a:63:eb:eb:9a:33:c3:
         c7:1c:e0:82:8d:22:8f:a9:6c:3d:54:72:a5:b2:40:7a:97:92:
         21:13:95:d1:45:88:15:04:ec:e3:cd:41:cc:cf:0a:8d:76:02:
         ab:4b:50:81
-----BEGIN CERTIFICATE-----
MIIE8zCCA9ugAwIBAgIJAI8ArqsoacGwMA0GCSqGSIb3DQEBBQUAMIGMMQswCQYD
VQQGEwJSVTEXMBUGA1UECBMOQ2VudHJhbCBSZWdpb24xDzANBgNVBAcTBk1vc2Nv
dzERMA8GA1UEChMIS01TZWFyY2gxHzAdBgNVBAsTFml4LXNhdGVsbGl0ZS5zZWFy
Y2gua20xHzAdBgNVBAMTFml4LXNhdGVsbGl0ZS5zZWFyY2gua20wHhcNMTQwNjAz
MTgwNjI1WhcNMzYwNTI4MTgwNjI1WjCBjDELMAkGA1UEBhMCUlUxFzAVBgNVBAgT
DkNlbnRyYWwgUmVnaW9uMQ8wDQYDVQQHEwZNb3Njb3cxETAPBgNVBAoTCEtNU2Vh
cmNoMR8wHQYDVQQLExZpeC1zYXRlbGxpdGUuc2VhcmNoLmttMR8wHQYDVQQDExZp
eC1zYXRlbGxpdGUuc2VhcmNoLmttMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIB
CgKCAQEA0xBzEgGY3XWIXFKIcTekZvOVsRTXrPLSA6OEy3mUN8wC+mNbqVegYaej
NdlCU4PHe9ljVR/5qnQi5nRoO/bd/994T+Js1d5amToB1srDmzvetZhHL43EeAiq
PBCJKhrJk5Ftfqq+8KiaohX6DCzAU0J0dg2m6MTfqeg7OzkgFUEyqfia/yyB4TPu
HuNbPaL4xgI+aDBN+NLyzaJVvuL5k09SqvQviGa1+MWI9+2UPgwhDWJbXx9wbRWV
95OOWH6wT5HchUrCDFnvhf3Uu0wtWzfzBD16wnhryuDk7qvo3pQcneDTBPwTvaxi
/tvkGyLdHWmmQgPuo64Livw2M946gwIDAQABo4IBVDCCAVAwDAYDVR0TBAUwAwEB
/zALBgNVHQ8EBAMCAqQwHQYDVR0lBBYwFAYIKwYBBQUHAwEGCCsGAQUFBwMCMDEG
CWCGSAGG+EIBDQQkFiJSSE4gU1NMIFRvb2wgR2VuZXJhdGVkIENlcnRpZmljYXRl
MB0GA1UdDgQWBBTbE3vjBGjNRG2QZ/AHjOdidyjF3TCBwQYDVR0jBIG5MIG2gBTb
E3vjBGjNRG2QZ/AHjOdidyjF3aGBkqSBjzCBjDELMAkGA1UEBhMCUlUxFzAVBgNV
BAgTDkNlbnRyYWwgUmVnaW9uMQ8wDQYDVQQHEwZNb3Njb3cxETAPBgNVBAoTCEtN
U2VhcmNoMR8wHQYDVQQLExZpeC1zYXRlbGxpdGUuc2VhcmNoLmttMR8wHQYDVQQD
ExZpeC1zYXRlbGxpdGUuc2VhcmNoLmttggkAjwCuqyhpwbAwDQYJKoZIhvcNAQEF
BQADggEBAH6uF12W08jD8WmydKQkKC2ceZB0XCdW03rnQgh4uYJYm4xVneguL2Oj
oSMn4Qlb67mb20ovgFTatE6TFm46kEAwyx6TgfRDVCfqXxIl5dyBXTdCOJ0zo3Ra
9QCibLmPWRER8e891fBDepntKVXXzLK3xzbdHj4cAT3ad7IWSC7mjFE7nfnKBezK
fR+xCRDural0kLUM56WZO7REMZoPd7XnDIWrqVNq2jFn7XKNLJjqOVQnh361w4B8
OWBAL6uQwcIiGvMV1yRaaNRXVmCc9y12OmPr65ozw8cc4IKNIo+pbD1UcqWyQHqX
kiETldFFiBUE7OPNQczPCo12AqtLUIE=
-----END CERTIFICATE-----

EOF
# ssl-key1
cat /tmp/ssl-key-* > /usr/share/rhn/RHN-ORG-TRUSTED-SSL-CERT
perl -pe 's/RHNS-CA-CERT/RHN-ORG-TRUSTED-SSL-CERT/g' -i /etc/sysconfig/rhn/up2date

mkdir -p /tmp/rhn_rpms/optional
cd /tmp/rhn_rpms/optional 
wget -P /tmp/rhn_rpms/optional http://ix-satellite.search.km/download/package/79622b52e8b6cbea0a6357cedeab8cff8959dafb/0/2/47040/libxml2-python-2.7.6-14.el6_5.2.x86_64.rpm http://ix-satellite.search.km/download/package/0c8ceac326ab77910e70311872292d1d21c60353/0/2/49016/pyOpenSSL-0.13.1-1.el6.x86_64.rpm http://ix-satellite.search.km/download/package/25517dace9cad95f0ea512719cf120d12d714a99/0/2/47034/libxml2-2.7.6-14.el6_5.2.x86_64.rpm http://ix-satellite.search.km/download/package/d8fe18a7eaa4f1235626fc24ac2ca4f0e7cc5ec0/0/2/34615/rhnlib-2.5.69-1.el6.noarch.rpm 
rpm -Uvh --replacepkgs --replacefiles /tmp/rhn_rpms/optional/pyOpenSSL* /tmp/rhn_rpms/optional/rhnlib* /tmp/rhn_rpms/optional/libxml2-python* /tmp/rhn_rpms/optional/libxml2* 
perl -npe 's|^(\s*(noSSLS\|s)erverURL\s*=\s*[^:]+://)[^/]*/|${1}ix-satellite.search.km/|' -i /etc/sysconfig/rhn/up2date
mkdir -p /etc/sysconfig/rhn/allowed-actions/script
touch /etc/sysconfig/rhn/allowed-actions/script/run
mkdir -p /etc/sysconfig/rhn/allowed-actions/configfiles
touch /etc/sysconfig/rhn/allowed-actions/configfiles/all

# now copy from the ks-tree we saved in the non-chroot checkout
cp -fav /tmp/ks-tree-copy/* /
rm -Rf /tmp/ks-tree-copy
# --End Spacewalk command section--

# begin cobbler snippet
# set default MOTD
echo "Kickstarted on $(date +'%Y-%m-%d')" >> /etc/motd

# begin Red Hat management server registration
mkdir -p /usr/share/rhn/
wget http://ix-satellite.search.km/pub/RHN-ORG-TRUSTED-SSL-CERT -O /usr/share/rhn/RHN-ORG-TRUSTED-SSL-CERT   
perl -npe 's/RHNS-CA-CERT/RHN-ORG-TRUSTED-SSL-CERT/g' -i /etc/sysconfig/rhn/*  
if [ -f /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release ]; then
    rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release
fi
key=1-d8f17b528b54eacad7c40b04a5daa58f,1-dc02192f57ad21dc7f611b311d52fec8
if [ -f /tmp/key ]; then
    key=`cat /tmp/key`,$key
fi

rhnreg_ks --serverUrl=https://ix-satellite.search.km/XMLRPC --sslCACert=/usr/share/rhn/RHN-ORG-TRUSTED-SSL-CERT --activationkey=$key
# end Red Hat management server registration

# end cobbler snippet

rhn_check

# Start post_install_network_config generated code
# End post_install_network_config generated code

%end


%post --interpreter /bin/bash --log /root/ks-post.log.1
echo "NETWORKING_IPV6=no" >> /etc/sysconfig/network
echo "net.ipv6.conf.all.disable_ipv6 = 1" >> /etc/sysctl.conf

sed -i 's/environment.*=.*/environment = first_time/' /etc/puppet/puppet.conf
sed -i 's/environments.*=.*/environments = first_time/' /etc/puppet/puppet.conf
sed -i 's/server.*=.*/server = puppet-101.ix.km/' /etc/puppet/puppet.conf
/sbin/chkconfig puppet on
service puppet start

/sbin/chkconfig --levels 345 sshd on
/sbin/chkconfig --levels 345 acpid on
/sbin/chkconfig --levels 345 ntpd on
/sbin/chkconfig --levels 345 ntpdate on

sed -i -e 's/\(^Defaults[[:space:]]*requiretty$\)/#\1/' /etc/sudoers

rm -fr /etc/yum.repos.d/*
echo "INTERVAL=60" > /etc/sysconfig/rhn/rhnsd
rhn-actions-control --enable-all

/sbin/chkconfig messagebus on
/sbin/chkconfig avahi-daemon on
/sbin/chkconfig libvirtd on

modprobe bridge
modprobe tun
modprobe kvm
modprobe kvm_intel

IPCONFIG=`cat /etc/sysconfig/network-scripts/ifcfg-eth0 | grep -v HWADDR | sed 's/TYPE.*/TYPE="Bridge"/' | sed 's/eth0/br0/'`
echo -e "$IPCONFIG" > /etc/sysconfig/network-scripts/ifcfg-br0
echo 'DELAY="0"' >> /etc/sysconfig/network-scripts/ifcfg-br0
grep "TYPE" /etc/sysconfig/network-scripts/ifcfg-br0 || echo 'TYPE="Bridge"' >> /etc/sysconfig/network-scripts/ifcfg-br0
HWADDR=`ifconfig | grep eth0 | awk '{print $5}'`
echo -e 'DEVICE="eth0"
BOOTPROTO="static"
HWADDR="'$HWADDR'"
NM_CONTROLLED="no"
ONBOOT="yes"
TYPE="Ethernet"
BRIDGE="br0"' > /etc/sysconfig/network-scripts/ifcfg-eth0

IPCONFIG=`cat /etc/sysconfig/network-scripts/ifcfg-eth1 | grep -v HWADDR | sed 's/TYPE.*/TYPE="Bridge"/' | sed 's/eth1/br1/'`
echo -e "$IPCONFIG" > /etc/sysconfig/network-scripts/ifcfg-br1
echo 'DELAY="0"' >> /etc/sysconfig/network-scripts/ifcfg-br1
grep "TYPE" /etc/sysconfig/network-scripts/ifcfg-br1 || echo 'TYPE="Bridge"' >> /etc/sysconfig/network-scripts/ifcfg-br1
HWADDR=`ifconfig|grep eth1 |awk '{print $5}'`
echo -e 'DEVICE="eth1"
BOOTPROTO="static"
HWADDR="'$HWADDR'"
NM_CONTROLLED="no"
ONBOOT="yes"
TYPE="Ethernet"
BRIDGE="br1"' > /etc/sysconfig/network-scripts/ifcfg-eth1

service network restart

mkdir -p /etc/libvirt/storage/autostart
mkdir -p /etc/libvirt/qemu/autostart
mkdir /var/run/libvirt
mkdir /var/run/libvirt/network
mkdir -p /etc/libvirt/storage/autostart
mkdir -p /etc/libvirt/qemu/autostart
mkdir /var/run/libvirt
mkdir /var/run/libvirt/network

/etc/init.d/messagebus restart
/etc/init.d/avahi-daemon restart
/etc/init.d/libvirtd restart

virsh net-undefine default
virsh net-destroy default
virsh pool-undefine default
virsh pool-destroy default
mkdir /etc/libvirt/storage
mkdir /etc/libvirt/storage/autostart

for volumegroup in $( vgs |grep -E "data[0-9]" |awk '{print $1$Cs9J81xU$rN.64VJYws0A2q4sXGRDR0
virsh pool-create-as --name $volumegroup --type logical --target /dev/$volumegroup
virsh pool-dumpxml $volumegroup > /etc/libvirt/storage/$volumegroup.xml
ln -s /etc/libvirt/storage/$volumegroup.xml /etc/libvirt/storage/autostart/
done
service libvirtd restart

yum -y update
rm -fr /etc/yum.repos.d/*

sed -i 's/osa_ssl_cert =.*/osa_ssl_cert = \/usr\/share\/rhn\/RHN-ORG-TRUSTED-SSL-CERT/' /etc/sysconfig/rhn/osad.conf
chkconfig osad on

#Run puppet right after install.
#This file will be overwritten automatically, after setting puppet environment
sed -i 's/splay\ .*=.*/splay = false/' /etc/puppet/puppet.conf
echo "* * * * * root puppet agent --no-daemonize --onetime >/dev/null 2>&1" > /etc/cron.d/puppet
%end

%post


# Start koan environment setup
echo "export COBBLER_SERVER=ix-satellite.search.km" > /etc/profile.d/cobbler.sh
echo "setenv COBBLER_SERVER ix-satellite.search.km" > /etc/profile.d/cobbler.csh
# End koan environment setup



wget "http://ix-satellite.search.km/cblr/svc/op/ks/profile/M9_Centos-6-5_Bare-Metal-1U_Standart-KVM-Host_x86-64:1:KMSearch" -O /root/cobbler.ks
wget "http://ix-satellite.search.km/cblr/svc/op/trig/mode/post/profile/M9_Centos-6-5_Bare-Metal-1U_Standart-KVM-Host_x86-64:1:KMSearch" -O /dev/null
%end
