# Kickstart config file generated by Spacewalk Config Management
# Profile Label : M9_Centos-6-5_Bare-Metal-1U_KVM-Host-bond-NORAID_x86-64
# Date Created  : 2014-06-03 19:40:01.356767

install
text
network --device=bond0 --noipv6 --bootproto=dhcp --onboot=yes --bondslaves=eth0,eth1 --bondopts=mode=802.3ad,miimon=100,xmit_hash_policy=layer3+4
url --url http://dist.ix.km/centos-6.5-x86_64
lang en_US.UTF-8
keyboard us
zerombr
clearpart --all
bootloader --location=mbr --driveorder=sda,sdb,sdc
timezone --utc Europe/Moscow
auth --enablemd5 --enableshadow
rootpw --iscrypted $1$Cs9J81xU$rN.64VJYws0A2q4sXGRDR0
selinux --disabled
reboot
firewall --disabled
skipx

repo --name=epel-6.5-x86_64 --baseurl=http://yum.ix.km/epel-6.5-x86_64
repo --name=centos-6.5-kmsearch-sys-prod-x86_64 --baseurl=http://yum.ix.km/centos-6.5-kmsearch-sys-prod-x86_64
repo --name=centos-6.5-kmsearch-apps-prod-x86_64 --baseurl=http://yum.ix.km/centos-6.5-kmsearch-apps-prod-x86_64

part /boot --asprimary --fstype="ext2" --ondisk=sda --size=200
part / --fstype ext4 --asprimary --size=40000 --ondisk=sda --fsoptions noatime,commit=30,data=writeback,nobh


%packages

@ Base
coreutils
yum
yum-plugin-priorities
rpm
e2fsprogs
lvm2
grub
sysstat
ntp
ntpdate
openssh-server
openssh-clients
vim-enhanced
OpenIPMI
sudo
e4fsprogs
mc
mtr
tcpdump
dstat
iotop
wget
rsync
iptstate
smartmontools
bind-utils
telnet
psmisc
man
kvm
virt-clone
bridge-utils
tunctl
libvirt
dmidecode
avahi
puppet
pbzip2
pigz
m2crypto
-dhcpv6-client
-iptables-ipv6
-system-config-securitylevel-tui
-wireless-tools
-rhpl
bash-completion
-cpuspeed
-abrt*
%end

#%pre
#%end

%pre --interpreter /bin/bash --log /tmp/ks-pre.log.1
sed -i -e 's/enabled=1/enabled=0/' /etc/yum/pluginconf.d/fastestmirror.conf
%end

%post --nochroot
mkdir /mnt/sysimage/tmp/ks-tree-copy
if [ -d /oldtmp/ks-tree-shadow ]; then
cp -fa /oldtmp/ks-tree-shadow/* /mnt/sysimage/tmp/ks-tree-copy
elif [ -d /tmp/ks-tree-shadow ]; then
cp -fa /tmp/ks-tree-shadow/* /mnt/sysimage/tmp/ks-tree-copy
fi
cp /etc/resolv.conf /mnt/sysimage/etc/resolv.conf
cp -f /tmp/ks-pre.log* /mnt/sysimage/root/ || :

cp `awk '{ if ($1$Cs9J81xU$rN.64VJYws0A2q4sXGRDR0
echo "Kickstarted on $(date +'%Y-%m-%d')" >> /etc/motd

%end

%post --log /root/ks-post.log

echo "NETWORKING_IPV6=no" >> /etc/sysconfig/network
echo "net.ipv6.conf.all.disable_ipv6 = 1" >> /etc/sysctl.conf
echo "NOZEROCONF=yes" >> /etc/sysconfig/network

cat << EOF >> /etc/sysconfig/network-scripts/ifcfg-br0
DEVICE="br0"
BOOTPROTO="dhcp"
IPV6INIT="no"
MTU="1500"
NM_CONTROLLED="yes"
ONBOOT="yes"
TYPE="bridge"
DELAY="0"
EOF

cat << EOF1 > /etc/sysconfig/network-scripts/ifcfg-bond0
DEVICE="bond0"
BONDING_OPTS="mode=802.3ad miimon=100 xmit_hash_policy=layer3+4"
BOOTPROTO="none"
ONBOOT="yes"
TYPE="Bond"
BRIDGE="br0"
NM_CONTROLLED="no"
LINKDELAY="5"
EOF1

cat << EOF2 >> /etc/sysconfig/network-scripts/ifcfg-eth0
MASTER="bond0"
SLAVE="yes"
EOF2

cat << EOF3 >> /etc/sysconfig/network-scripts/ifcfg-eth1
MASTER="bond0"
SLAVE="yes"
EOF3

cat << EOF4 > /etc/puppet/puppet.conf
[main]
logdir = /var/log/puppet
rundir = /var/run/puppet
pluginsource = puppet:///plugins
pluginfactsource = puppet:///pluginfacts
[agent]
use_srv_records = true
srv_domain = ix.km
ignorecache     = true
pidfile         = /var/run/puppet/agent.pid
node_name_fact = fqdn
pluginsync = true
# Set by ENC through puppetconf module.
environment =
EOF4

/sbin/chkconfig puppet on
service puppet start

/sbin/chkconfig --levels 345 sshd on
/sbin/chkconfig --levels 345 acpid on
/sbin/chkconfig --levels 345 ntpd on
/sbin/chkconfig --levels 345 ntpdate on

sed -i -e 's/\(^Defaults[[:space:]]*requiretty$\)/#\1/' /etc/sudoers

/sbin/chkconfig messagebus on
/sbin/chkconfig avahi-daemon on
/sbin/chkconfig libvirtd on

modprobe bridge
modprobe tun
modprobe kvm
modprobe kvm_intel

mkdir -p /etc/libvirt/storage/autostart
mkdir -p /etc/libvirt/qemu/autostart
mkdir /var/run/libvirt
mkdir /var/run/libvirt/network
mkdir -p /etc/libvirt/storage/autostart
mkdir -p /etc/libvirt/qemu/autostart
mkdir /var/run/libvirt
mkdir /var/run/libvirt/network

/etc/init.d/messagebus restart
/etc/init.d/avahi-daemon restart
/etc/init.d/libvirtd restart

virsh net-undefine default
virsh net-destroy default
virsh pool-undefine default
virsh pool-destroy default
mkdir /etc/libvirt/storage
mkdir /etc/libvirt/storage/autostart

for volumegroup in $( vgs |grep -E "data[0-9]" |awk '{print $1$Cs9J81xU$rN.64VJYws0A2q4sXGRDR0
virsh pool-create-as --name $volumegroup --type logical --target /dev/$volumegroup
virsh pool-dumpxml $volumegroup > /etc/libvirt/storage/$volumegroup.xml
ln -s /etc/libvirt/storage/$volumegroup.xml /etc/libvirt/storage/autostart/
done
service libvirtd restart

rm -fr /etc/yum.repos.d/*
yum -y update
yum -y remove kernel-firmware
yum -y install http://yum.ix.km/centos-6.5-updates-x86_64/kernel-firmware-2.6.32-431.53.2.el6.x86_64.rpm http://yum.ix.km/centos-6.5-updates-x86_64/kernel-2.6.32-431.53.2.el6.x86_64.rpm
echo -en '\xFE\xFF\xFF' | dd of=/dev/sda bs=1 seek=451
echo -en '\xFE\xFF\xFF' | dd of=/dev/sdb bs=1 seek=451
echo -en '\xFE\xFF\xFF' | dd of=/dev/sdc bs=1 seek=451

rpm -i http://yum.ix.km/centos-6.5-x86_64/sputnik-repo-centos-zabbix-prod-1.1-7.noarch.rpm
%end
