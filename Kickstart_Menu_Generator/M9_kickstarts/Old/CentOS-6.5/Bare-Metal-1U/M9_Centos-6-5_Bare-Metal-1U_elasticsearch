# Kickstart config file generated by Spacewalk Config Management
# Profile Label : M9_Centos-6-5_Bare-Metal-1U_elasticsearch_x86-64
# Date Created  : 2014-06-30 17:04:24.292615

install
text
network --device=bond0 --noipv6 --bootproto=dhcp --onboot=yes --bondslaves=eth0,eth1 --bondopts=mode=802.3ad,miimon=100,xmit_hash_policy=layer3+4
url --url http://ix-satellite.search.km/ks/dist/centos-6.5-x86_64
lang en_US.UTF-8
keyboard us
zerombr
clearpart --all --initlabel --drives=sda,sdb,sdc
bootloader --location=mbr --driveorder=sda
timezone --utc Europe/Moscow
auth --enablemd5 --enableshadow
rootpw --iscrypted $1$Cs9J81xU$rN.64VJYws0A2q4sXGRDR0
selinux --disabled
reboot
firewall --disabled
skipx
repo --name=spacewalk-client-centos-6.5-x86_64 --baseurl=http://ix-satellite.search.km/ks/dist/child/spacewalk-client-centos-6.5-x86_64/centos-6.5-x86_64
repo --name=epel-6.5-x86_64 --baseurl=http://ix-satellite.search.km/ks/dist/child/epel-6.5-x86_64/centos-6.5-x86_64
repo --name=centos-6.5-kmsearch-sys-prod-x86_64 --baseurl=http://ix-satellite.search.km/ks/dist/child/centos-6.5-kmsearch-sys-prod-x86_64/centos-6.5-x86_64
part /boot --asprimary --fstype="ext2" --ondisk=sda --size=200
part swap --asprimary --ondisk=sda --size=10240
part / --fstype ext4 --asprimary --size=40960 --ondisk=sda --fsoptions noatime,commit=30,data=writeback,nobh
part /var --fstype ext4 --asprimary --size=1 --grow --ondisk=sda --fsoptions noatime,commit=30,data=writeback,nobh
part raid.01 --asprimary --fstype="raid" --grow --ondisk=sdb --size=1
part raid.02 --asprimary --fstype="raid" --grow --ondisk=sdc --size=1
raid /var/lib/elasticsearch --device=md0 --fstype="ext4" --level=0 raid.01 raid.02 --fsoptions noatime,commit=30,data=writeback,nobh


%packages 
coreutils
yum
rpm
e2fsprogs
lvm2
grub
sysstat
ntp
openssh-server
openssh-clients
vim-enhanced
puppet
ipmiutil
OpenIPMI
sudo
e4fsprogs
syslog-ng
mc
mtr
tcpdump
htop
dstat
iotop
wget
rsync
atop
iptstate
smartmontools
bind-utils
psmisc
pbzip2
pigz
rhn-client-tools
rhn-check
rhn-setup
rhnsd
m2crypto
yum-rhn-plugin
rhncfg
rhncfg-actions
rhncfg-client
-dhcpv6-client
-iptables-ipv6
-system-config-securitylevel-tui
-wireless-tools
-rhpl
-abrt-addon-ccpp
-abrt-addon-kerneloops
-abrt-addon-python
-abrt-cli
-alsa-lib
-alsa-utils
-avahi-libs
-cairo
-cifs-utils
-cups-libs
-cyrus-sasl-plain
-dejavu-fonts-common
-desktop-file-utils
-fprintd
-fprintd-pam
-gtk2
-latencytop
-libfprint
-libx11
-nano
-pango
-pycairo
-python-matplotlib
-samba-client
-seekwatcher
-smart
-xorg-x11-drv-ati-firmware
bash-completion
-cpuspeed
-abrt*
osad
%end

%pre

wget "http://ix-satellite.search.km/cblr/svc/op/trig/mode/pre/profile/M9_Centos-6-5_Bare-Metal-1U_elasticsearch_x86-64:1:KMSearch" -O /dev/null



echo "Saving RHN keys..." > /dev/ttyS0
SYSTEM_ID=/etc/sysconfig/rhn/systemid
rhn_keys_found=no

mkdir -p /tmp/rhn

drives=$(list-harddrives | awk '{print $1$Cs9J81xU$rN.64VJYws0A2q4sXGRDR0
for disk in $drives; do
    DISKS="$DISKS $(fdisk -l /dev/$disk | grep -v "swap\|LVM\|Extended" | awk '/^\/dev/{print $1$Cs9J81xU$rN.64VJYws0A2q4sXGRDR0
done

# Try to find the keys on ordinary partitions
for disk in $DISKS; do
    name=test-$(basename $disk)
    mkdir -p /tmp/$name
    mount $disk /tmp/$name
    [ $? -eq 0 ] || continue # Skip to the next partition if the mount fails

    # Copy current RHN host keys out to be reused
    if [ -f /tmp/${name}$SYSTEM_ID ]; then
        cp -a /tmp/${name}$SYSTEM_ID /tmp/rhn
        rhn_keys_found="yes"
        umount /tmp/$name
        break
    fi
    umount /tmp/$name
    rm -r /tmp/$name
done

# Try LVM if that didn't work
if [ "$rhn_keys_found" = "no" ]; then
    lvm lvmdiskscan
    vgs=$(lvm vgs | tail -n +2 | awk '{ print $1$Cs9J81xU$rN.64VJYws0A2q4sXGRDR0
    for vg in $vgs; do
        # Activate any VG we found
        lvm vgchange -ay $vg
    done
    
    lvs=$(lvm lvs | tail -n +2 | awk '{ print "/dev/" $2 "/" $1$Cs9J81xU$rN.64VJYws0A2q4sXGRDR0
    for lv in $lvs; do
        tmpdir=$(mktemp -d findkeys.XXXXXX)
        mkdir -p /tmp/${tmpdir}
        mount $lv /tmp/${tmpdir} || continue # Skip to next volume if this fails

        # Let's see if the keys are in there
        if [ -f /tmp/${tmpdir}$SYSTEM_ID ]; then
            cp -a /tmp/${tmpdir}$SYSTEM_ID /tmp/rhn/
            rhn_keys_found="yes"
            umount /tmp/${tmpdir}
            break # We're done!
        fi
        umount /tmp/${tmpdir}
        rm -r /tmp/${tmpdir}
    done
    
    # And clean up..
    for vg in $vgs; do
        lvm vgchange -an $vg
    done
fi


%end

%post --nochroot
mkdir /mnt/sysimage/tmp/ks-tree-copy
if [ -d /oldtmp/ks-tree-shadow ]; then
cp -fa /oldtmp/ks-tree-shadow/* /mnt/sysimage/tmp/ks-tree-copy
elif [ -d /tmp/ks-tree-shadow ]; then
cp -fa /tmp/ks-tree-shadow/* /mnt/sysimage/tmp/ks-tree-copy
fi
cp /etc/resolv.conf /mnt/sysimage/etc/resolv.conf
cp -f /tmp/ks-pre.log* /mnt/sysimage/root/ || :

cp `awk '{ if ($1$Cs9J81xU$rN.64VJYws0A2q4sXGRDR0
%end

%post --nochroot --interpreter /usr/bin/python
try:
    import xmlrpclib
    import shutil
    import sys
    import os.path
    old_system_id = "/tmp/rhn/systemid"
    new_system_id = "/mnt/sysimage/root/systemid.old"
    tmp_key = "/mnt/sysimage/tmp/key"

    new_keys = "1-37c6f296edea9c73e068afba3f79da88,1-52463a00232ca344b154d3d205069a94"
    for key in new_keys.split(','):
        if key.startswith('re-'):
            sys.exit(0)
    if os.path.exists(old_system_id):
        client =  xmlrpclib.Server("http://ix-satellite.search.km/rpc/api")
        key = client.system.obtain_reactivation_key(open(old_system_id).read())
        if os.path.exists(tmp_key):
            f = open(tmp_key, "r+")
            contents = f.read()
            if contents and not contents[-1] == ',':
                f.write(',')
        else:
            f = open(tmp_key, "w")
        f.write(key)
        f.close()
        shutil.copy(old_system_id, new_system_id)
except:
    # xml rpc due to  a old/bad system id
    # we don't care about those
    # we'll register those as new.
    pass


%end

%post --log /root/ks-rhn-post.log
# --Begin Spacewalk command section--
cat > /tmp/gpg-key-1 <<'EOF'
-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: GnuPG v1.2.6 (GNU/Linux)

mQGiBEWfB6MRBACrnYW6yKMT+MwJlCIhoyTxGf3mAxmnAiDEy6HcYN8rivssVTJk
CFtQBlBOpLV/OW2YtKrCO2xHn46eNfnMri8FGT8g+9JF3MUVi7kiV1He4iJynHXB
+F2ZqIvHf3IaUj1ys+p8TK64FDFxDQDrGQfIsD/+pkSGx53/877IrvdwjwCguQcr
Ioip5TH0Fj0OLUY4asYVZH8EAIqFHEqsY+9ziP+2R3/FyxSllKkjwcMLrBug+cYO
LYDD6eQXE9Mq8XKGFDj9ZB/0+JzK/XQeStheeFG75q3noq5oCPVFO4czuKErIRAB
qKbDBhaTj3JhOgM12XsUYn+rI6NeMV2ZogoQCC2tWmDETfRpYp2moo53NuFWHbAy
XjETA/sHEeQT9huHzdi/lebNBj0L8nBGfLN1nSRP1GtvagBvkR4RZ6DTQyl0UzOJ
RA3ywWlrL9IV9mrpb1Fmn60l2jTMMCc7J6LacmPK906N+FcN/Docj1M4s/4CNanQ
NhzcFhAFtQL56SNyLTCk1XzhssGZ/jwGnNbU/aaj4wOj0Uef5LRGQ2VudE9TLTUg
S2V5IChDZW50T1MgNSBPZmZpY2lhbCBTaWduaW5nIEtleSkgPGNlbnRvcy01LWtl
eUBjZW50b3Mub3JnPohkBBMRAgAkBQJFnwekAhsDBQkSzAMABgsJCAcDAgMVAgMD
FgIBAh4BAheAAAoJEKikR9zoViiXKlEAmwSoZDvZo+WChcg3s/SpNoWCKhMAAJwI
E2aXpZVrpsQnInUQWwkdrTiL5YhMBBMRAgAMBQJFnwiSBYMSzAIRAAoJEDjCFhY5
bKCk0hAAn134bIx3wSbq58E6P6U5RT7Z2Zx4AJ9VxnVkoGHkVIgSdsxHUgRjo27N
F7kBDQRFnwezEAQA/HnJ5yiozwgtf6jt+kii8iua+WnjqBKomPHOQ8moxbWdv5Ks
4e1DPhzRqxhshjmub4SuJ93sgMSAF2ayC9t51mSJV33KfzPF2gIahcMqfABe/2hJ
aMzcQZHrGJCEX6ek8l8SFKou7vICzyajRSIK8gxWKBuQknP/9LKsoczV+xsAAwUD
/idXPkk4vRRHsCwc6I23fdI0ur52bzEqHiAIswNfO521YgLk2W1xyCLc2aYjc8Ni
nrMX1tCnEx0/gK7ICyJoWH1Vc7//79sWFtX2EaTO+Q07xjFX4E66WxJlCo9lOjos
Vk5qc7R+xzLDoLGFtbzaTRQFzf6yr7QTu+BebWLoPwNTiE8EGBECAA8FAkWfB7MC
GwwFCRLMAwAACgkQqKRH3OhWKJfvvACfbsF1WK193zM7vSc4uq51XsceLwgAoI0/
9GxdNhGQEAweSlQfhPa3yYXH
=o/Mx
-----END PGP PUBLIC KEY BLOCK-----
EOF
# gpg-key1
rpm --import /tmp/gpg-key-1
cat > /tmp/gpg-key-2 <<'EOF'
-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: GnuPG v2.0.18 (GNU/Linux)

mQGiBE9V9U0RBADjRxY1+Ng5gzaAj2LYHNwXHzyH65p+jL80+2vkf6WCNvewa+zK
SY8JH3syZMhjGi/vW3TcDy5KVqiXS2rpMJS6zCBrOJbtcFdV3VvbsPd7hK9COlph
NUx5RSIIwZRg1wyEjgeuYOSLuIhqNsI+fjXk+uzletSLtIYUF3TUq5jCvwCg4XQ/
/RPOFH6KiHfIx8QUZmvT0IkD/ip7pOn5uSPNiIbj3X5RYbz8PB/z5OuoenfzYn4R
WDBXZBlWMaPJCupAYwdP9IsiXo8WvbyXPHgG91P/MStrCgOffACNhuMus1FwqlCQ
VFuKENB6f2g4DY9Mow6bKYgsSEy0qnEF5I2M+BqjApO0oznxzcyJ4coXQdA9/oCP
vYU5A/9FTgukU1p/CbNJIhT4iH+vE6cKFGAtzhwwQxMdnii8ctcKiCYgiimuU7OG
rcPKR1xsRX/sc6XZYJeLmc1Lt7Btkdl36RY5BgesVJkUNyKh8+7MllW5PvVFvtGv
vvvrRVK+mJYxdBU0/Sqc94ZgBW6vdvRwHgXhpKor6NsCfJUWvLQmU3BhY2V3YWxr
IDxzcGFjZXdhbGstZGV2ZWxAcmVkaGF0LmNvbT6IaAQTEQIAKAUCT1X1TQIbAwUJ
BKKGAAYLCQgHAwIGFQgCCQoLBBYCAwECHgECF4AACgkQDmRvaIY6hT16sQCfVuJv
KnSWzWXo0ek16NrqUSgdTYIAn3Q6Jc3GAzkx/JgmA6T6pLxp2f1uiEYEEBECAAYF
Ak9V/egACgkQ7WNTebOJITK97gCfdeNye+OKidB2huEfzxP37ZkdfSIAniAA4NMY
QsmjPPkUJSVguO7GbdXSuQINBE9V9U0QCACBbWXaPP5RqAIGnr9LeFbSYpWs2SnL
KPv0qylyOGMc3GwmpJjeuz1d4y5fHIQxsQl7+RLIxOARcYH1QL6gHN450JcpYzau
/Lj1ArsAP/QK/J8YSmjG0E0rU8sYRWIu7jzISgfMAs3c3wNvOMUCiXtXFV6crm9q
3kbrZTedWLkShSLDAp5394hmBbRicWnc9h4LwBKp+BBtsvJFfDydc8IJUGZLZNZT
RayYWC5VMDe1xmOZXhNpDxfNrjhUUI6E6qWwdinmzifhP6z6YNtRON1yWSLBwtcr
LghyEJlilijIbCDgZ8Nvtqy/c2ypcLxMrXy70x05fjcQK2KIuLI58GGDAAMFB/9n
m5YLj4S4XxF8/xP7givuPq37C7NYLOuzFKKx6xxqngV8TNGDVU2zv/lieh2ussXE
XF/S9Du2abpXYgxsxwFJNMMKXUam03ExFSUvUAco6nmxySzvtgudCZ/9HqLhbNVu
RpyUNA/g9vkYK6KVdxAeHUdu/EwfSL/pCEc11Dw1jYqbihktlTQPcizsSPG4Y7jh
OUrKgxJop9DovUGzuUSl/7zYr4W7TiGV3my0f7U3qkpVT0bQoMnw8TxCZj4x3umo
F4klakeGX0FK4vwV5hDq32Q6vWN804F34Vi3WsaUT9G1E3H7/s/OQgWLOm16mgjR
pN1E79kYwtPMCAz0pYMciE8EGBECAA8FAk9V9U0CGwwFCQSihgAACgkQDmRvaIY6
hT3D2ACfYsiYS39rFdR1aBHviE0hVm9MWxUAnR3Ua92zW/0UoJ7TgxR0Dxzta37z
=yqYQ
-----END PGP PUBLIC KEY BLOCK-----
EOF
# gpg-key2
rpm --import /tmp/gpg-key-2
cat > /tmp/gpg-key-3 <<'EOF'
-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: GnuPG v1.4.5 (GNU/Linux)

mQINBE4P1EIBEACfrYbqfmCxVzfO3P9NGC2Ul9EyzDNW9WK0yYt1kT45cjybC+vL
8gPl5BlVC9Z5WoSU9YhCwk/RdQ0aQJQRziEyQqwftSgKESrApAqEyHIkcsPNCkjq
55q9MkhJApMn14dwvCJCgubDSj2Ft8b172IlIX3k196uCZl9j5EVUHuyxls4AOUZ
7wuvEXLu01KOi5lqnsGwyRTv+AV74LupL03iZUPQuGUWPuP25J35sC4p33We5Ogx
VrjOv6/e5Z0p9zb2AgBh1hFRwPPgE3wrYJIF5tmJgDDdKIPcNFE1l2QiOlPg/QA4
t0f6gUk0ptgrWlNmAhj8y8ccomf/JgmjfQbjFXWkqIePVzQy9adM6SbmKFm/czJ1
X1Jsy7lCzpxYqz8RYds8EzD455auJ0TeiO4P0PFd+RXncH10mGIESP/DTicWvVdK
0doBLpYcpwyNL4dyQxq28xtneFgYV+Zkazk0HzF3+x+vnD+LZ1Zc9/MXub/Yt5nv
1eaQrSfSkCDvq5rXzzprqVe6Ytl+FK5lwbJGhOUWfsWk0PqChkEhw2n7zgHpQ5Qd
U5oMFFKy3B1ZYQRn581/wB+eL/fgku7icIo/IOU7zeKDmIK7xHuHiAmVtm7L35VL
qAbgSY5B5EBqP6RtBT7AIKzM/+H5uMvnS4xI5PVkJVijL6Fpw8aHEeCDVQARAQAB
tFdDZW50T1MtNiBEZWJ1Z2luZm8gS2V5IChDZW50T1MtNiBEZWJ1Z2luZm8gU2ln
bmluZyBLZXkpIDxjZW50b3MtNi1kZWJ1Zy1rZXlAY2VudG9zLm9yZz6JAjwEEwEC
ACYFAk4P1EICGwMFCRLMAwAGCwkIBwMCBBUCCAMEFgIDAQIeAQIXgAAKCRA7dc95
0P89FkPID/4w8+3Yg7lZfTkPynWcSX4KOH6NRCSbuUf+5MFmZT4FXVOr7LHOWCRS
QkF3f+tpPIpGLcEFD9r0/9npozsviG/13ZhT31x3mmASvVVGVp9cHN5Ie7Zim2BN
+ALbGQ0YbaO7f7XgBMTKTlw71HQ5V4yCqrUVBL1FicGBsBJ5nfJt/K0WjKA1GGYA
DyW1YP/Oid5lPNqPLyR3Jw2oMHtUtbwZbtgBSq8Ll5gZaYTpap+M4SdQmBXyOMxA
NPXSwJgNuWufKnwp+7qMR/sFRIW9qmRvR30NtonmzOwf+kOtY03USiSK4pneEHTQ
YKAGCEdOgsPOnEwv0jvW3KABIw+rwRzkpfW0IFh0VoyOrQ67Ek0Q3oldQ9Lrjwqu
qsL12YhBgfnMkSM/w7R0HsezOSmPb0wHxjIb6CDv+4r9LIHx5F4YXFytv7pYIUqP
6ATg9jJ/ecMcXVonnwwUG2FtQNhYa4URak1u3u0xJTKsrsvMnYksjCpgosmd4XB4
7651UvR7pgsSscJSuLlh9S4BR3/crsYZMq1O5L9HOywU4l2SN04p+DfH2Vf90VfB
9An1uA2hBa5lB1IuN0QiIH9OMaDqXPk0rVHS0GJ28Jx4rztofDBWHuShgO5YzNUw
A8CKB3t/kH6zutLdF6tS0Mh1wLWuPWfSH4DPd+mSucY/zbbrrAgxFA==
=9b/M
-----END PGP PUBLIC KEY BLOCK-----
EOF
# gpg-key3
rpm --import /tmp/gpg-key-3
cat > /tmp/gpg-key-4 <<'EOF'
-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: GnuPG v1.2.6 (GNU/Linux)

mQGiBEXopTIRBACZDBMOoFOakAjaxw1LXjeSvh/kmE35fU1rXfM7T0AV31NATCLF
l5CQiNDA4oWreDThg2Bf6+LIVTsGQb1V+XXuLak4Em5yTYwMTVB//4/nMxQEbpl/
QB2XwlJ7EQ0vW+kiPDz/7pHJz1p1jADzd9sQQicMtzysS4qT2i5A23j0VwCg1PB/
lpYqo0ZhWTrevxKMa1n34FcD/REavj0hSLQFTaKNLHRotRTF8V0BajjSaTkUT4uk
/RTaZ8Kr1mTosVtosqmdIAA2XHxi8ZLiVPPSezJjfElsSqOAxEKPL0djfpp2wrTm
l/1iVnX+PZH5DRKCbjdCMLDJhYap7YUhcPsMGSeUKrwmBCBJUPc6DhjFvyhA9IMl
1T0+A/9SKTv94ToP/JYoCTHTgnG5MoVNafisfe0wojP2mWU4gRk8X4dNGKMj6lic
vM6gne3hESyjcqZSmr7yELPPGhI9MNauJ6Ob8cTR2T12Fmv9w03DD3MnBstR6vhP
QcqZKhc5SJYYY7oVfxlSOfF4xfwcHQKoD5TOKwIAQ6T8jyFpKbQkRmVkb3JhIEVQ
RUwgPGVwZWxAZmVkb3JhcHJvamVjdC5vcmc+iGQEExECACQFAkXopTICGwMFCRLM
AwAGCwkIBwMCAxUCAwMWAgECHgECF4AACgkQEZzANiF1IfabmQCgzvE60MnHSOBa
ZXXF7uU2Vzu8EOkAoKg9h+j0NuNom6WUYZyJQt4zc5seuQINBEXopTYQCADapnR/
blrJ8FhlgNPl0X9S3JE/kygPbNXIqne4XBVYisVp0uzNCRUxNZq30MpY027JCs2J
nL2fMpwvx33f0phU029vrIZKA3CmnnwVsjcWfMJOVPBmVN7m5bGU68F+PdRIcDsl
PMOWRLkTBZOGolLgIbM4719fqA8etewILrX6uPvRDwywV7/sPCFpRcfNNBUY+Zx3
5bf4fnkaCKxgXgQS3AT+hGYhlzIqQVTkGNveHTnt4SSzgAqR9sSwQwqvEfVtYNeS
w5rDguLG41HQm1Hojv59HNYjH6F/S1rClZi21bLgZbKpCFX76qPt8CTw+iQLBPPd
yoOGHfzyp7nsfhUrAAMFB/9/H9Gpk822ZpBexQW4y3LGFo9ZSnmu+ueOZPU3SqDA
DW1ovZdYzGuJTGGM9oMl6bL8eZrcUBBOFaWge5wZczIE3hx2exEOkDdvq+MUDVD1
axmN45q/7h1NYRp5GQL2ZsoV4g9U2gMdzHOFtZCER6PP9ErVlfJpgBUCdSL93V4H
Sgpkk7znmTOklbCM6l/G/A6q4sCRqfzHwVSTiruyTBiU9lfROsAl8fjIq2OzWJ2T
P9sadBe1llUYaow7txYSUxssW+89avct35gIyrBbof5M+CBXyAOUaSWmpM2eub24
0qbqiSr/Y6Om0t6vSzR8gRk7g+1H6IE0Tt1IJCvCAMimiE8EGBECAA8FAkXopTYC
GwwFCRLMAwAACgkQEZzANiF1IfZQYgCgiZHCv4xb+sTHCn/otc1Ovvi/OgMAnRXY
bbsLFWOfmzAnNIGvFRWy+YHi
=MMNL
-----END PGP PUBLIC KEY BLOCK-----
EOF
# gpg-key4
rpm --import /tmp/gpg-key-4
cat > /tmp/ssl-key-1 <<'EOF'
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number: 10304427997564354992 (0x8f00aeab2869c1b0)
    Signature Algorithm: sha1WithRSAEncryption
        Issuer: C=RU, ST=Central Region, L=Moscow, O=KMSearch, OU=ix-satellite.search.km, CN=ix-satellite.search.km
        Validity
            Not Before: Jun  3 18:06:25 2014 GMT
            Not After : May 28 18:06:25 2036 GMT
        Subject: C=RU, ST=Central Region, L=Moscow, O=KMSearch, OU=ix-satellite.search.km, CN=ix-satellite.search.km
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)
                Modulus:
                    00:d3:10:73:12:01:98:dd:75:88:5c:52:88:71:37:
                    a4:66:f3:95:b1:14:d7:ac:f2:d2:03:a3:84:cb:79:
                    94:37:cc:02:fa:63:5b:a9:57:a0:61:a7:a3:35:d9:
                    42:53:83:c7:7b:d9:63:55:1f:f9:aa:74:22:e6:74:
                    68:3b:f6:dd:ff:df:78:4f:e2:6c:d5:de:5a:99:3a:
                    01:d6:ca:c3:9b:3b:de:b5:98:47:2f:8d:c4:78:08:
                    aa:3c:10:89:2a:1a:c9:93:91:6d:7e:aa:be:f0:a8:
                    9a:a2:15:fa:0c:2c:c0:53:42:74:76:0d:a6:e8:c4:
                    df:a9:e8:3b:3b:39:20:15:41:32:a9:f8:9a:ff:2c:
                    81:e1:33:ee:1e:e3:5b:3d:a2:f8:c6:02:3e:68:30:
                    4d:f8:d2:f2:cd:a2:55:be:e2:f9:93:4f:52:aa:f4:
                    2f:88:66:b5:f8:c5:88:f7:ed:94:3e:0c:21:0d:62:
                    5b:5f:1f:70:6d:15:95:f7:93:8e:58:7e:b0:4f:91:
                    dc:85:4a:c2:0c:59:ef:85:fd:d4:bb:4c:2d:5b:37:
                    f3:04:3d:7a:c2:78:6b:ca:e0:e4:ee:ab:e8:de:94:
                    1c:9d:e0:d3:04:fc:13:bd:ac:62:fe:db:e4:1b:22:
                    dd:1d:69:a6:42:03:ee:a3:ae:0b:8a:fc:36:33:de:
                    3a:83
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Basic Constraints: 
                CA:TRUE
            X509v3 Key Usage: 
                Digital Signature, Key Encipherment, Certificate Sign
            X509v3 Extended Key Usage: 
                TLS Web Server Authentication, TLS Web Client Authentication
            Netscape Comment: 
                RHN SSL Tool Generated Certificate
            X509v3 Subject Key Identifier: 
                DB:13:7B:E3:04:68:CD:44:6D:90:67:F0:07:8C:E7:62:77:28:C5:DD
            X509v3 Authority Key Identifier: 
                keyid:DB:13:7B:E3:04:68:CD:44:6D:90:67:F0:07:8C:E7:62:77:28:C5:DD
                DirName:/C=RU/ST=Central Region/L=Moscow/O=KMSearch/OU=ix-satellite.search.km/CN=ix-satellite.search.km
                serial:8F:00:AE:AB:28:69:C1:B0

    Signature Algorithm: sha1WithRSAEncryption
         7e:ae:17:5d:96:d3:c8:c3:f1:69:b2:74:a4:24:28:2d:9c:79:
         90:74:5c:27:56:d3:7a:e7:42:08:78:b9:82:58:9b:8c:55:9d:
         e8:2e:2f:63:a3:a1:23:27:e1:09:5b:eb:b9:9b:db:4a:2f:80:
         54:da:b4:4e:93:16:6e:3a:90:40:30:cb:1e:93:81:f4:43:54:
         27:ea:5f:12:25:e5:dc:81:5d:37:42:38:9d:33:a3:74:5a:f5:
         00:a2:6c:b9:8f:59:11:11:f1:ef:3d:d5:f0:43:7a:99:ed:29:
         55:d7:cc:b2:b7:c7:36:dd:1e:3e:1c:01:3d:da:77:b2:16:48:
         2e:e6:8c:51:3b:9d:f9:ca:05:ec:ca:7d:1f:b1:09:10:ee:ad:
         a9:74:90:b5:0c:e7:a5:99:3b:b4:44:31:9a:0f:77:b5:e7:0c:
         85:ab:a9:53:6a:da:31:67:ed:72:8d:2c:98:ea:39:54:27:87:
         7e:b5:c3:80:7c:39:60:40:2f:ab:90:c1:c2:22:1a:f3:15:d7:
         24:5a:68:d4:57:56:60:9c:f7:2d:76:3a:63:eb:eb:9a:33:c3:
         c7:1c:e0:82:8d:22:8f:a9:6c:3d:54:72:a5:b2:40:7a:97:92:
         21:13:95:d1:45:88:15:04:ec:e3:cd:41:cc:cf:0a:8d:76:02:
         ab:4b:50:81
-----BEGIN CERTIFICATE-----
MIIE8zCCA9ugAwIBAgIJAI8ArqsoacGwMA0GCSqGSIb3DQEBBQUAMIGMMQswCQYD
VQQGEwJSVTEXMBUGA1UECBMOQ2VudHJhbCBSZWdpb24xDzANBgNVBAcTBk1vc2Nv
dzERMA8GA1UEChMIS01TZWFyY2gxHzAdBgNVBAsTFml4LXNhdGVsbGl0ZS5zZWFy
Y2gua20xHzAdBgNVBAMTFml4LXNhdGVsbGl0ZS5zZWFyY2gua20wHhcNMTQwNjAz
MTgwNjI1WhcNMzYwNTI4MTgwNjI1WjCBjDELMAkGA1UEBhMCUlUxFzAVBgNVBAgT
DkNlbnRyYWwgUmVnaW9uMQ8wDQYDVQQHEwZNb3Njb3cxETAPBgNVBAoTCEtNU2Vh
cmNoMR8wHQYDVQQLExZpeC1zYXRlbGxpdGUuc2VhcmNoLmttMR8wHQYDVQQDExZp
eC1zYXRlbGxpdGUuc2VhcmNoLmttMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIB
CgKCAQEA0xBzEgGY3XWIXFKIcTekZvOVsRTXrPLSA6OEy3mUN8wC+mNbqVegYaej
NdlCU4PHe9ljVR/5qnQi5nRoO/bd/994T+Js1d5amToB1srDmzvetZhHL43EeAiq
PBCJKhrJk5Ftfqq+8KiaohX6DCzAU0J0dg2m6MTfqeg7OzkgFUEyqfia/yyB4TPu
HuNbPaL4xgI+aDBN+NLyzaJVvuL5k09SqvQviGa1+MWI9+2UPgwhDWJbXx9wbRWV
95OOWH6wT5HchUrCDFnvhf3Uu0wtWzfzBD16wnhryuDk7qvo3pQcneDTBPwTvaxi
/tvkGyLdHWmmQgPuo64Livw2M946gwIDAQABo4IBVDCCAVAwDAYDVR0TBAUwAwEB
/zALBgNVHQ8EBAMCAqQwHQYDVR0lBBYwFAYIKwYBBQUHAwEGCCsGAQUFBwMCMDEG
CWCGSAGG+EIBDQQkFiJSSE4gU1NMIFRvb2wgR2VuZXJhdGVkIENlcnRpZmljYXRl
MB0GA1UdDgQWBBTbE3vjBGjNRG2QZ/AHjOdidyjF3TCBwQYDVR0jBIG5MIG2gBTb
E3vjBGjNRG2QZ/AHjOdidyjF3aGBkqSBjzCBjDELMAkGA1UEBhMCUlUxFzAVBgNV
BAgTDkNlbnRyYWwgUmVnaW9uMQ8wDQYDVQQHEwZNb3Njb3cxETAPBgNVBAoTCEtN
U2VhcmNoMR8wHQYDVQQLExZpeC1zYXRlbGxpdGUuc2VhcmNoLmttMR8wHQYDVQQD
ExZpeC1zYXRlbGxpdGUuc2VhcmNoLmttggkAjwCuqyhpwbAwDQYJKoZIhvcNAQEF
BQADggEBAH6uF12W08jD8WmydKQkKC2ceZB0XCdW03rnQgh4uYJYm4xVneguL2Oj
oSMn4Qlb67mb20ovgFTatE6TFm46kEAwyx6TgfRDVCfqXxIl5dyBXTdCOJ0zo3Ra
9QCibLmPWRER8e891fBDepntKVXXzLK3xzbdHj4cAT3ad7IWSC7mjFE7nfnKBezK
fR+xCRDural0kLUM56WZO7REMZoPd7XnDIWrqVNq2jFn7XKNLJjqOVQnh361w4B8
OWBAL6uQwcIiGvMV1yRaaNRXVmCc9y12OmPr65ozw8cc4IKNIo+pbD1UcqWyQHqX
kiETldFFiBUE7OPNQczPCo12AqtLUIE=
-----END CERTIFICATE-----

EOF
# ssl-key1
cat /tmp/ssl-key-* > /usr/share/rhn/RHN-ORG-TRUSTED-SSL-CERT
perl -pe 's/RHNS-CA-CERT/RHN-ORG-TRUSTED-SSL-CERT/g' -i /etc/sysconfig/rhn/up2date

mkdir -p /tmp/rhn_rpms/optional
cd /tmp/rhn_rpms/optional 
wget -P /tmp/rhn_rpms/optional http://ix-satellite.search.km/download/package/efff42050e0a171e9252029536cb99b7a126f736/0/2/13766/pyOpenSSL-0.10-2.el6.x86_64.rpm http://ix-satellite.search.km/download/package/79622b52e8b6cbea0a6357cedeab8cff8959dafb/0/2/47040/libxml2-python-2.7.6-14.el6_5.2.x86_64.rpm http://ix-satellite.search.km/download/package/25517dace9cad95f0ea512719cf120d12d714a99/0/2/47034/libxml2-2.7.6-14.el6_5.2.x86_64.rpm http://ix-satellite.search.km/download/package/d8fe18a7eaa4f1235626fc24ac2ca4f0e7cc5ec0/0/2/34615/rhnlib-2.5.69-1.el6.noarch.rpm 
rpm -Uvh --replacepkgs --replacefiles /tmp/rhn_rpms/optional/pyOpenSSL* /tmp/rhn_rpms/optional/rhnlib* /tmp/rhn_rpms/optional/libxml2-python* /tmp/rhn_rpms/optional/libxml2* 
perl -npe 's|^(\s*(noSSLS\|s)erverURL\s*=\s*[^:]+://)[^/]*/|${1}ix-satellite.search.km/|' -i /etc/sysconfig/rhn/up2date
mkdir -p /etc/sysconfig/rhn/allowed-actions/script
touch /etc/sysconfig/rhn/allowed-actions/script/run
mkdir -p /etc/sysconfig/rhn/allowed-actions/configfiles
touch /etc/sysconfig/rhn/allowed-actions/configfiles/all

# now copy from the ks-tree we saved in the non-chroot checkout
cp -fav /tmp/ks-tree-copy/* /
rm -Rf /tmp/ks-tree-copy
# --End Spacewalk command section--

# begin cobbler snippet
# set default MOTD
echo "Kickstarted on $(date +'%Y-%m-%d')" >> /etc/motd

# begin Red Hat management server registration
mkdir -p /usr/share/rhn/
wget http://ix-satellite.search.km/pub/RHN-ORG-TRUSTED-SSL-CERT -O /usr/share/rhn/RHN-ORG-TRUSTED-SSL-CERT   
perl -npe 's/RHNS-CA-CERT/RHN-ORG-TRUSTED-SSL-CERT/g' -i /etc/sysconfig/rhn/*  
if [ -f /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release ]; then
    rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release
fi
key=1-37c6f296edea9c73e068afba3f79da88,1-52463a00232ca344b154d3d205069a94
if [ -f /tmp/key ]; then
    key=`cat /tmp/key`,$key
fi

rhnreg_ks --serverUrl=https://ix-satellite.search.km/XMLRPC --sslCACert=/usr/share/rhn/RHN-ORG-TRUSTED-SSL-CERT --activationkey=$key
# end Red Hat management server registration

# end cobbler snippet

rhn_check

# Start post_install_network_config generated code
# End post_install_network_config generated code

%end


%post --interpreter /bin/bash --log /root/ks-post.log.1
echo "NETWORKING_IPV6=no" >> /etc/sysconfig/network
echo "net.ipv6.conf.all.disable_ipv6 = 1" >> /etc/sysctl.conf

sed -i 's/environment.*=.*/environment = first_time/' /etc/puppet/puppet.conf
sed -i 's/environments.*=.*/environments = first_time/' /etc/puppet/puppet.conf
sed -i 's/server.*=.*/server = puppet-101.ix.km/' /etc/puppet/puppet.conf
/sbin/chkconfig puppet on
service puppet start

/sbin/chkconfig --levels 345 sshd on
/sbin/chkconfig --levels 345 acpid on
/sbin/chkconfig --levels 345 ntpd on
/sbin/chkconfig --levels 345 ntpdate on

sed -i -e 's/\(^Defaults[[:space:]]*requiretty$\)/#\1/' /etc/sudoers

rm -fr /etc/yum.repos.d/*
echo "INTERVAL=60" > /etc/sysconfig/rhn/rhnsd
rhn-actions-control --enable-all

yum -y update
rm -fr /etc/yum.repos.d/*

sed -i 's/osa_ssl_cert =.*/osa_ssl_cert = \/usr\/share\/rhn\/RHN-ORG-TRUSTED-SSL-CERT/' /etc/sysconfig/rhn/osad.conf
chkconfig osad on

%end

%post


# Start koan environment setup
echo "export COBBLER_SERVER=ix-satellite.search.km" > /etc/profile.d/cobbler.sh
echo "setenv COBBLER_SERVER ix-satellite.search.km" > /etc/profile.d/cobbler.csh
# End koan environment setup



wget "http://ix-satellite.search.km/cblr/svc/op/ks/profile/M9_Centos-6-5_Bare-Metal-1U_elasticsearch_x86-64:1:KMSearch" -O /root/cobbler.ks
wget "http://ix-satellite.search.km/cblr/svc/op/trig/mode/post/profile/M9_Centos-6-5_Bare-Metal-1U_elasticsearch_x86-64:1:KMSearch" -O /dev/null
%end
