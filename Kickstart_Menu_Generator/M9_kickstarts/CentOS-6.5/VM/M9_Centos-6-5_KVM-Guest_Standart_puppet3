# Kickstart config file generated by Spacewalk Config Management
# Profile Label : M9_Centos-6-5_KVM-Guest_Standart_x86-64
# Date Created  : 2014-06-03 19:40:11.273744

install
text
network --device eth0 --bootproto dhcp 
url --url http://dist.ix.km/centos-6.5-x86_64
lang en_US.UTF-8
keyboard us
zerombr
clearpart --all
bootloader --location=mbr --driveorder=vda
timezone --utc Europe/Moscow
auth --enablemd5 --enableshadow
rootpw --iscrypted $1$Cs9J81xU$rN.64VJYws0A2q4sXGRDR0
selinux --disabled
reboot
firewall --disabled
skipx

repo --name=centos-6.5-kmsearch-apps-prod-x86_64 --baseurl=http://yum.ix.km/centos-6.5-kmsearch-apps-prod-x86_64
repo --name=epel-6.5-x86_64 --baseurl=http://yum.ix.km/epel-6.5-x86_64
#repo --name=centos-6.5-kmsearch-sys-prod-x86_64 --baseurl=http://yum.ix.km/centos-6.5-kmsearch-sys-prod-x86_64
repo --name=centos-6.5-puppet3-x86_64 --baseurl=http://yum.ix.km/centos-6.5-puppet3-x86_64

part /boot --asprimary --fstype="ext2" --ondisk=vda --size=200
part swap --asprimary --fstype="swap" --ondisk=vda --size=4000
part / --asprimary --fstype="ext4" --grow --ondisk=vda --size=1 --fsoptions noatime,commit=30,data=writeback,nobh

%packages
coreutils
yum
rpm
e2fsprogs
lvm2
grub
sysstat
yum-plugin-priorities
ntp
ntpdate
openssh-server
openssh-clients
vim-enhanced
OpenIPMI
sudo
e4fsprogs
mc
acpid
tcpdump
dstat
iotop
wget
rsync
iptstate
smartmontools
bind-utils
telnet
psmisc
man
m2crypto
-dhcpv6-client
-iptables-ipv6
-system-config-securitylevel-tui
-wireless-tools
-rhpl
puppet
bash-completion
-cpuspeed
-abrt*
%end

%pre --interpreter /bin/bash --log /tmp/ks-pre.log.1
leasefile=`ls /var/lib/dhclient/* | tail -n 1` 
dname=`cat $leasefile | grep 'option domain-name ' | awk '{print $3}' | awk -F'"' '{print $2}'` 
hname=`cat $leasefile | grep 'option host-name ' | awk '{print $3}' | awk -F'"' '{print $2}'`
hostname="$hname.$dname"
echo "HOSTNAME=$hostname" >> /etc/sysconfig/network
%end

%post --nochroot

cp /etc/resolv.conf /mnt/sysimage/etc/resolv.conf
cp -f /tmp/ks-pre.log* /mnt/sysimage/root/ || :
cp `awk '{ if ($1$Cs9J81xU$rN.64VJYws0A2q4sXGRDR0

%end

%post --log /root/ks-post.log

echo "Kickstarted on $(date +'%Y-%m-%d')" >> /etc/motd

echo "NETWORKING_IPV6=no" >> /etc/sysconfig/network
echo "net.ipv6.conf.all.disable_ipv6 = 1" >> /etc/sysctl.conf
echo "NOZEROCONF=yes" >> /etc/sysconfig/network

cat << EOF > /etc/puppet/puppet.conf
[main]
logdir = /var/log/puppet
rundir = /var/run/puppet
pluginsource = puppet:///plugins
pluginfactsource = puppet:///pluginfacts
[agent]
use_srv_records = true
srv_domain = search.km
ignorecache     = true
pidfile         = /var/run/puppet/agent.pid
node_name_fact = fqdn
pluginsync = true
# Set by ENC through puppetconf module.
environment = basic
EOF

#/sbin/chkconfig puppet on
#service puppet start

/sbin/chkconfig --levels 345 sshd on
/sbin/chkconfig --levels 345 acpid on
/sbin/chkconfig --levels 345 ntpd on
/sbin/chkconfig --levels 345 ntpdate on

sed -i -e 's/\(^Defaults[[:space:]]*requiretty$\)/#\1/' /etc/sudoers

rm -fr /etc/yum.repos.d/*
#yum -y update


#Run puppet right after install.
#This file will be overwritten automatically, after setting puppet environment
#sed -i 's/splay\ .*=.*/splay = false/' /etc/puppet/puppet.conf

#kernel update
yum -y remove kernel-firmware
yum -y install http://yum.ix.km/centos-6.5-x86_64/sputnik-repo-centos-zabbix-prod-1.1-7.noarch.rpm http://yum.ix.km/centos-6.5-updates-x86_64/kernel-firmware-2.6.32-431.53.2.el6.x86_64.rpm http://yum.ix.km/centos-6.5-updates-x86_64/kernel-2.6.32-431.53.2.el6.x86_64.rpm
%end
